---
layout: post
title:  "house of your mother's mourning hallâ€”â€”ä¸€ç§å…¨æ–°çš„å †åˆ©ç”¨æ–¹æ³•"
date:   2021-5-25
desc: ""
keywords: ""
categories: [Life]
tags: []
icon: icon-html
---



## Abstract

GNU Libc is the standard C runtime library of most Linux distributions for PC and servers. There used to be many memory corruption exploit techniques against ptmalloc. But the widely deployment of mitigations on modern operating systems and continuous patching to ptmalloc effectively fuck most of these techniques. In this paper, ðŸ‘´ present some new exploit methods against ptmalloc along with proof of concept code.

## house of your mother's mourning hall

è¯¥æ”»å‡»æ–¹å¼é€‚ç”¨äºŽæ‰€æœ‰ libc

å½“ç¨‹åºä¸­å­˜åœ¨ `system("/bin/sh")` æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ getshell

æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ liibc ä¸‹çš„ get_shell_attack ä»¥åŠ input_666 åˆ©ç”¨ï¼Œæ¥é…åˆ libc ä¸‹çš„ system_attack è¿›è¡Œç»„åˆåˆ©ç”¨çš„æ–¹æ³•ã€‚ä¸»è¦é€‚ç”¨äºŽç¨‹åºä¸­ä»…æœ‰ gift å‡½æ•°èƒ½ç”¨ï¼Œå…¶ä»–é€‰é¡¹éƒ½ä¸ç®¡ç”¨çš„æƒ…å†µã€‚ï¼ˆå› ä¸ºé€‰æ‹©å…¶ä»–é€‰é¡¹åªä¼šæ‰“å° NO_IMPLEMENTï¼Œæ— æ³•å®Œæˆå¸¸è§„çš„ tcache attack ç­‰åˆ©ç”¨ï¼‰

è¯¥æ–¹æ³•æœ€ä¸ºæ ¸å¿ƒçš„åœ°æ–¹åœ¨äºŽï¼Œåˆ©ç”¨äº† glibc ä¸­ system() å‡½æ•°å¯ä»¥ getshellï¼Œå¹¶ä¸”æ‰§è¡Œ system() å‡½æ•°å¯ä»¥é€šè¿‡è¾“å…¥ 666 è¿› gift() å®žçŽ°ã€‚

å…³äºŽ libc ä¸‹çš„ input_666 çš„æ‰‹æ³•å¯ä»¥å‚è€ƒï¼š[c-switch è¯­å¥](https://www.runoob.com/cprogramming/c-switch.html)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæ˜¯å¯ä»¥æ‰§è¡Œ gift() å‡½æ•°ã€‚

å…³äºŽ libc ä¸‹çš„ system_attack çš„ç»†èŠ‚è¯¦è§ï¼š[libc æºç ](http://www.gnu.org/software/libc/)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæœ‰ä¸€å †ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯è¯¥æ”»å‡»å¯ä»¥ get shell æ•ˆæžœç‰¹æ€§ã€‚

### example

è¿™é‡Œä»¥ mourning hall ctf final çš„ house of your mother's mourning hall é¢˜ç›®ä¸ºä¾‹

```
======================
    mourning hall
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:
```

èœå•åªæœ‰äº”ä¸ªé€‰é¡¹ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬è¾“å…¥ 666ï¼Œå°±å¯ä»¥è¿›å…¥ giftï¼Œè°ƒç”¨ `system("/bin/sh")`

```
======================
    mourning hall
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:666
# cat flag
flag{nmsl}
```

ç›®å‰å·²ç»æœ‰å¾ˆå¤š gift 666 åˆ©ç”¨çš„é¢˜ç›®ï¼Œä½†æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æŠŠè¿™ç§°ä½œ house of your mother's mourning hallï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ç§å…¨æ–°çš„å †åˆ©ç”¨æ–¹æ³•

## build the mourning hall

å¦‚ä½•å‡ºä¸€é“è€ƒå¯Ÿ hom çš„é¢˜ç›®

1. æ‰¾ä¸€é“é¢˜
2. æœ‰æºç å°±ç›´æŽ¥ç”¨ï¼Œæ²¡æºç é‡å¤ 1ï¼Œæˆ–è€…è‡ªå·±ç…§ç€å†™ä¸€é
3. æŠŠèœå•æ¢æˆ house of your mother's mourning hall
4. æ·»åŠ  house of your mother's mourning hall çŸ¥è¯†ç‚¹
5. é¢˜ç›®åç§°ï¼šhouse of your mother's mourning hall
6. éš¾åº¦æ ‡ä¸ºå›°éš¾ï¼Œæ‰“åŒ…äº¤ç»™ä¸»åŠžæ–¹ï¼Œç­‰ç€æ”¶é’±
7. ä¸»åŠžæ–¹åŠžæ¯”èµ›ç”¨åˆ°è¿™é“é¢˜æ—¶ï¼Œç›´æŽ¥å‚èµ›

### example

æ‰¾åˆ°[ç¬¬å…­å±Šè´µæ ¡ä¿¡æ¯å®‰å…¨ç«žèµ›](https://aidaip.github.io/life/2021/05/25/%E7%AC%AC%E5%85%AD%E5%B1%8A%E8%B4%B5%E6%A0%A1%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B.html)ä¸­çš„ White_Give_Flag

```c
void menu(){
   puts("======================");
   puts("      White Give      ");
   puts("======================");
   puts("1.Add");
   puts("2.Show");
   puts("3.Delete");
   puts("4.Edit");
   puts("5.Exit");
   puts("======================");
   printf("choice:");
}
```

ä¿®æ”¹èœå•

```c
void menu(){
   puts("======================");
   puts("    mourning hall     ");
   puts("======================");
   puts("1.NM$L");
   puts("2.Show the corpse");
   puts("3.Cremate your mother");
   puts("4.Edit the corpse");
   puts("5.Exit");
   puts("======================");
   printf("choice:");
}
```

å‡ºå¥½äº†ï¼æ­¤æ—¶ï¼Œæˆ‘æå‡ºä¸€ç§å…¨æ–°çš„å †åˆ©ç”¨æ–¹æ³•ï¼šhouse of your mother's mourning hall plus

## house of your mother's mourning hall plus

è¯¥æ”»å‡»æ–¹å¼é€‚ç”¨äºŽæ‰€æœ‰ libc

å½“ç¨‹åºå¯ä»¥æ‰“å° flag æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥å¾—åˆ° flag

æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ liibc ä¸‹çš„ open_read_flag ä»¥åŠ puts_flag åˆ©ç”¨ï¼Œæ¥é…åˆ libc ä¸‹çš„ read_ret_0 è¿›è¡Œç»„åˆåˆ©ç”¨çš„æ–¹æ³•ã€‚ä¸»è¦é€‚ç”¨äºŽç¨‹åºä¸­ä»…æœ‰ gift å‡½æ•°èƒ½ç”¨ï¼Œå…¶ä»–é€‰é¡¹éƒ½ä¸ç®¡ç”¨çš„æƒ…å†µã€‚ï¼ˆå› ä¸ºé€‰æ‹©å…¶ä»–é€‰é¡¹åªä¼šæ‰“å° NO_IMPLEMENTï¼Œæ— æ³•å®Œæˆå¸¸è§„çš„ tcache attack ç­‰åˆ©ç”¨ï¼‰

è¯¥æ–¹æ³•æœ€ä¸ºæ ¸å¿ƒçš„åœ°æ–¹åœ¨äºŽï¼Œåˆ©ç”¨äº† glibc ä¸­ read() å‡½æ•°å¯ä»¥è¿”å›ž 0ï¼Œå¹¶ä¸”æ‰§è¡Œ puts(array[0]) å‡½æ•°å¯ä»¥é€šè¿‡ read() è¿”å›ž 0 å®žçŽ°ã€‚

å…³äºŽ libc ä¸‹çš„ puts_flag çš„æ‰‹æ³•å¯ä»¥å‚è€ƒï¼š[c-æ•°ç»„](https://www.runoob.com/cprogramming/c-switch.html)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæ˜¯å¯ä»¥æ‰“å° flagã€‚

å…³äºŽ libc ä¸‹çš„ read_ret_0 çš„ç»†èŠ‚è¯¦è§ï¼š[libc æºç ](http://www.gnu.org/software/libc/)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæ˜¯è¿”å›ž 0 ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯è¯¥æ”»å‡»å¯ä»¥è¿”å›ž 0 æ•ˆæžœç‰¹æ€§ã€‚

### example

è¿™é‡Œä»¥ mourning hall ctf final çš„ house of your mother's mourning hall plus é¢˜ç›®ä¸ºä¾‹

```
======================
    mourning hall
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:
```

è¯»å–é€‰é¡¹æ—¶è¿”å›žå€¼æ˜¯ read() è¿”å›žå€¼

```c
int read_choice(){
    char buf[8];
    int ret = read(0,buf,8);
    int choice = atoi(buf);
    if(ret > 5){
        exit(0);
    }
    if(ret < 0){
        exit(0);
    }
    return ret;
}
```

æ¯ä¸ªé€‰é¡¹éƒ½ä¼šæ‰“å°å¯¹åº”å­—ç¬¦ä¸²

```c
choice = read_choice();
puts(msg_ptr[choice]);
```

çœŸæ­£çš„æ ¸å¿ƒæ¼æ´žæ˜¯åœ¨ init() ä¸­ï¼Œè¿™é‡ŒæŠŠ flag è¯»äº†ï¼Œæ”¾åˆ° `msg_ptr[0]`

è¿™é‡Œæ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼Œæˆ‘åœ¨å‡ºé¢˜çš„æ—¶å€™æŠŠå˜é‡åæ”¹äº†ï¼Œæ¯”åªæ”¹èœå•ä¸çŸ¥é“é«˜åˆ°å“ªé‡ŒåŽ»äº†ã€‚

```c
void init(){
    open("./flag",0);
    read(3,flag,38);
    close(3);
    msg_ptr[0] = flag;
    msg_ptr[1] = nmsl_msg;
    msg_ptr[2] = show_the_corpse_msg;
    msg_ptr[3] = cremate_your_mother_msg;
    msg_ptr[4] = edit_the_corpse_msg;
    msg_ptr[5] = bye_msg;
    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);
}
```

ç”±äºŽæ¯ä¸ªåŠŸèƒ½éƒ½æ²¡æœ‰å®žçŽ°

```c
void add(){
	puts("NO_IMPLEMENT");
}

void show(){
	puts("NO_IMPLEMENT");
}

void delete(){
	puts("NO_IMPLEMENT");
}

void edit(){
	puts("NO_IMPLEMENT");
}

```

æ‰€ä»¥æ— æ³•ä½¿ç”¨ tcache attackï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½ç”¨ fastbin attackã€‚

è¿™é‡Œå°±éœ€è¦åˆ©ç”¨æˆ‘ä»¬çš„ house of your mother's mourning hallã€‚è¯¦è§ exp

```c
from pwn import *
r = process('./pwn')
r.recvuntil('choice:')
r.shutdown_raw('send')
r.interactive()
```

read() è¯»åˆ° EOF è¿”å›ž 0ï¼Œputs() è¶Šç•Œæ‰“å° flag

```
======================
    mourning hall
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:flag{nmsl}

Invalid!
```

## house of your mother's ashes

è¯¥æ”»å‡»æ–¹å¼é€‚ç”¨äºŽæ‰€æœ‰ libc

å½“ç¨‹åºä¸­å­˜åœ¨ `system("/bin/sh")` æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ getshell

æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ liibc ä¸‹çš„ get_shell_attack ä»¥åŠ input_nmsl åˆ©ç”¨ï¼Œæ¥é…åˆ libc ä¸‹çš„ system_attack è¿›è¡Œç»„åˆåˆ©ç”¨çš„æ–¹æ³•ã€‚ä¸»è¦é€‚ç”¨äºŽç¨‹åºä¸­ä»…æœ‰ gift å‡½æ•°èƒ½ç”¨ï¼Œå…¶ä»–é€‰é¡¹éƒ½ä¸ç®¡ç”¨çš„æƒ…å†µã€‚ï¼ˆå› ä¸ºé€‰æ‹©å…¶ä»–é€‰é¡¹åªä¼šæ‰“å° NO_IMPLEMENTï¼Œæ— æ³•å®Œæˆå¸¸è§„çš„ tcache attack ç­‰åˆ©ç”¨ï¼‰

è¯¥æ–¹æ³•æœ€ä¸ºæ ¸å¿ƒçš„åœ°æ–¹åœ¨äºŽï¼Œåˆ©ç”¨äº† glibc ä¸­ system() å‡½æ•°å¯ä»¥ getshellï¼Œå¹¶ä¸”æ‰§è¡Œ system() å‡½æ•°å¯ä»¥é€šè¿‡è¾“å…¥ nmsl è¿› gift() å®žçŽ°ã€‚

å…³äºŽ libc ä¸‹çš„ input_nmsl çš„æ‰‹æ³•å¯ä»¥å‚è€ƒï¼š[c åº“å‡½æ•° strncmp()](https://www.runoob.com/cprogramming/c-function-strncmp.html)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæ˜¯å¯ä»¥æ‰§è¡Œ gift() å‡½æ•°ã€‚

å…³äºŽ libc ä¸‹çš„ system_attack çš„ç»†èŠ‚è¯¦è§ï¼š[libc æºç ](http://www.gnu.org/software/libc/)ï¼Œè¯¥æ”»å‡»çš„æœ€ç»ˆæ•ˆæžœæœ‰ä¸€å †ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯è¯¥æ”»å‡»å¯ä»¥ get shell æ•ˆæžœç‰¹æ€§ã€‚

è¯¥åˆ©ç”¨æ–¹æ³•å¯¹ house of your mother's mourning hall è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå› ä¸ºå·²ç»æå‡º house of your mother's mourning hall plus å¹¶ä¸”æˆ‘æ›´æƒ³æå‡ºä¸€ä¸ªæ–°çš„ house ofï¼Œæˆ‘å†³å®šæŠŠè¿™ç§åˆ©ç”¨æ–¹æ³•ç§°ä¸º house of your mother's ashesã€‚

åœ¨ house of your mother's mourning hall ä¸­ï¼Œéœ€è¦è¾“å…¥ 666 æ‰èƒ½è¿›å…¥ gift() å‡½æ•°ï¼Œä½†æ˜¯è¾“å…¥ 666 å¹¶ä¸å¥‘åˆ house of your mother's mourning hall è¿™ä¸€åç§°ï¼Œæ‰€ä»¥æˆ‘å¯¹è¯¥åˆ©ç”¨æ–¹æ³•è¿›è¡Œä¼˜åŒ–ï¼Œå°†è¾“å…¥ 666 æ”¹ä¸ºè¾“å…¥ nmslï¼Œä½¿å…¶ä¸Žåç§°æ›´åŠ ç¬¦åˆï¼Œæå‡º house of your mother's ashes è¿™ä¸€å…¨æ–°çš„åˆ©ç”¨æ–¹æ³•ã€‚

### example

è¿™é‡Œä»¥ mourning hall ctf final çš„ house of your mother's ashes é¢˜ç›®ä¸ºä¾‹

```
======================
        ashes
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:
```

èœå•åªæœ‰äº”ä¸ªé€‰é¡¹ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬è¾“å…¥ nmslï¼Œå°±å¯ä»¥è¿›å…¥ giftï¼Œè°ƒç”¨ `system("/bin/sh")`

```
======================
    mourning hall
======================
1.NM$L
2.Show the corpse
3.Cremate your mother
4.Edit the corpse
5.Exit
======================
choice:nmsl
# cat flag
flag{nmsl}
```

