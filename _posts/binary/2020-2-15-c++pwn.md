---
clayout: post
title:  "c++pwn"
date:   2020-2-15
desc: ""
keywords: ""
categories: [Binary]
tags: []
icon: icon-html
---

# c++pwn

c++pwnï¼Œå°±æ˜¯è‰¹cè‰¹

### Name Mangling

å…ˆå­¦æ´‹æ–‡

```
mangling	è‹±[ËˆmÃ¦Å‹É¡lÉªÅ‹]    ç¾[ËˆmÃ¦Å‹É¡lÉªÅ‹]
v.	å‹ç¢; æ’•çƒ‚; ä¸¥é‡æŸå; ç³Ÿè¹‹(å¦‚è¹©è„šçš„è¯—æœ—è¯µæˆ–æ‹™åŠ£çš„æ¼”å¥);
[è¯å…¸] mangleçš„ç°åœ¨åˆ†è¯;
[ä¾‹å¥] Or such mangling can be performed automatically after an executable is created.
æˆ–è€…ä¹Ÿå¯ä»¥ç­‰åˆ°å¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆä¹‹åå†è‡ªåŠ¨åŒ–åˆ‡ç¢ã€‚
[å…¶ä»–] åŸå‹ï¼š mangle
```

Name Manglingå°±æ˜¯ç¼–è¯‘å™¨æŠŠğŸ‘´èµ·çš„å‡½æ•°åç²‰ç¢äº†

```c++
void func1(int a, int b){}
int func2(double a, int b){return 0;}
```

```
g++ -c test.cpp -o test.o
nm -a test.o
0000000000000000 b .bss
0000000000000000 n .comment
0000000000000000 d .data
0000000000000000 r .eh_frame
0000000000000000 n .note.GNU-stack
0000000000000000 t .text
0000000000000000 T _Z5func1ii
000000000000000d T _Z5func2di
0000000000000000 a test.cpp
```

ğŸ‘´çš„å‡½æ•°åæ˜¯func1ã€func1ï¼ŒName Manglingåå˜æˆ\_Z5func1iiã€\_Z5func2di

_Zï¼Œ5æ˜¯åŸæ¥çš„å‡½æ•°åé•¿åº¦ï¼Œiiï¼Œdiæ˜¯å‚æ•°ç±»å‹

```c++
namespace wdnmd
{
	class white_give
	{
	public:
		void abcdefgknmlgb(int a){}
	};
}

int main(int argc, char const *argv[])
{
	wdnmd::white_give eggplant;
	eggplant.abcdefgknmlgb(0);
	return 0;
}
```

```
g++ -o test test.cpp
nm test
...
00000000000006b4 W _ZN5wdnmd10white_give13abcdefgknmlgbEi
...
```

_ZNå¼€å¤´ï¼Œ5æ˜¯å‘½åç©ºé—´åç§°é•¿åº¦ï¼Œ10æ˜¯ç±»åé•¿åº¦ï¼Œ13æ˜¯å‡½æ•°åé•¿åº¦ï¼ŒEç»“å°¾ï¼Œåé¢æ˜¯å‚æ•°ç±»å‹

c++filtå¯ä»¥å€’å›å»çœ‹çœ‹

```
c++filt _ZN5wdnmd10white_give13abcdefgknmlgbEi
wdnmd::white_give::abcdefgknmlgb(int)
```

gdbä¸­å¯ä»¥ä½¿ç”¨`set print asm-demangle on`

Name manglingä½¿æ¯ä¸€ä¸ªåç§°è½¬æ¢åæœ‰å”¯ä¸€çš„åç§°ï¼Œç¼–ç ç®€å•å¯é€†

* g++ä¸­Name manglingç¼–ç æ–¹æ³•
  1. \_Zå¼€å¤´ï¼Œå¦‚æœæœ‰ä½œç”¨åŸŸï¼Œ\_ZNå¼€å¤´
  2. é•¿åº¦+åç§°
  3. å¦‚æœæœ‰ä½œç”¨åŸŸï¼ŒEç»“å°¾
  4. å‚æ•°ç±»å‹



### Virtual function table

#### è™šå‡½æ•°è¡¨

ç±»çš„è™šå‡½æ•°è¡¨æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œæ¯ä¸ªå†…å­˜å•å…ƒä¸­è®°å½•ä¸€ä¸ªåœ°å€

è™šå‡½æ•°çš„åœ°å€å­˜æ”¾äºè™šå‡½æ•°è¡¨ä¹‹ä¸­

è™šè¡¨å±äºç±»ï¼Œè€Œä¸æ˜¯å±äºæŸä¸ªå…·ä½“çš„å¯¹è±¡ã€‚åŒä¸€ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä½¿ç”¨åŒä¸€ä¸ªè™šè¡¨

ç±»çš„å¯¹è±¡å†…éƒ¨ä¼šæœ‰æŒ‡å‘ç±»å†…éƒ¨çš„è™šè¡¨åœ°å€çš„æŒ‡é’ˆ(*__vptr )ï¼Œç±»çš„å¯¹è±¡åœ¨åˆ›å»ºæ—¶ä¾¿æ‹¥æœ‰äº†è¿™ä¸ªæŒ‡é’ˆï¼Œä¸”è¿™ä¸ªæŒ‡é’ˆçš„å€¼ä¼šè‡ªåŠ¨è¢«è®¾ç½®ä¸ºæŒ‡å‘ç±»çš„è™šè¡¨ã€‚ é€šè¿‡è¿™ä¸ªæŒ‡é’ˆè®¿é—®è™šå‡½æ•°è¡¨ï¼Œç„¶åéå†å…¶ä¸­å‡½æ•°æŒ‡é’ˆï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å‡½æ•°ã€‚

å•ç»§æ‰¿æ´¾ç”Ÿç±»ä¸­ä»…æœ‰ä¸€ä¸ªè™šå‡½æ•°è¡¨ï¼Œæ— è®ºæ´¾ç”Ÿç±»æœ‰æ²¡æœ‰é‡å†™åŸºç±»çš„è™šå‡½æ•°ï¼Œè¿™ä¸ªè™šå‡½æ•°è¡¨å’ŒåŸºç±»çš„è™šå‡½æ•°è¡¨éƒ½ä¸æ˜¯ä¸€ä¸ªè¡¨ï¼Œå¦‚æœæ´¾ç”Ÿç±»æ²¡æœ‰é‡å†™åŸºç±»çš„è™šå‡½æ•°ï¼ŒåŸºç±»å’Œæ´¾ç”Ÿç±»çš„è™šå‡½æ•°è¡¨æŒ‡å‘çš„å‡½æ•°åœ°å€ç›¸åŒ

![1](https://raw.githubusercontent.com/AiDaiP/images/master/æ²¡æœ‰å¯¹è±¡å¦‚ä½•é¢å‘å¯¹è±¡/1.png)

```c++
#include<iostream>

class white_give
{
public:
	virtual void gg1(){}
	virtual void gg2(){}
};

class eggplant : public white_give
{
public:
	virtual void gg1(){std::cout<<"wdnmd"<<std::endl;}
};

void debug(){}
int main(int argc, char const *argv[])
{
	white_give *a = new white_give();
	eggplant *b = new eggplant();
	eggplant *c = new eggplant();
	debug();
	return 0;
}
```

```
0x613e60:       0x0000000000000000      0x0000000000000021//a
0x613e70:       0x0000000000600dc8      0x0000000000000000
0x613e80:       0x0000000000000000      0x0000000000000021//b
0x613e90:       0x0000000000600da8      0x0000000000000000
0x613ea0:       0x0000000000000000      0x0000000000000021//c
0x613eb0:       0x0000000000600da8      0x0000000000000000
0x613ec0:       0x0000000000000000      0x000000000000f141
```

0x600dc8æ˜¯white_giveç±»çš„è™šè¡¨

```
0x600dc8 <vtable for white_give+16>:    0x0000000000400986      0x0000000000400992
```

0x600da8æ˜¯eggplantç±»çš„è™šè¡¨

```
0x600da8 <vtable for eggplant+16>:      0x000000000040099e      0x0000000000400992
```

0x400986æ˜¯white_giveç±»çš„gg1()

0x40099eæ˜¯eggplantç±»é‡å†™çš„gg1()

0x400992æ˜¯gg2()



å¤šç»§æ‰¿æƒ…å†µä¸‹ï¼Œæ´¾ç”Ÿç±»ä¸­æœ‰å¤šä¸ªè™šå‡½æ•°è¡¨ï¼Œè™šå‡½æ•°çš„æ’åˆ—æ–¹å¼å’Œç»§æ‰¿çš„é¡ºåºä¸€è‡´ã€‚æ´¾ç”Ÿç±»é‡å†™å‡½æ•°å°†ä¼šè¦†ç›–æ‰€æœ‰è™šå‡½æ•°è¡¨çš„åŒåå†…å®¹ï¼Œæ´¾ç”Ÿç±»è‡ªå®šä¹‰æ–°çš„è™šå‡½æ•°å°†ä¼šåœ¨ç¬¬ä¸€ä¸ªç±»çš„è™šå‡½æ•°è¡¨çš„åé¢è¿›è¡Œæ‰©å……ã€‚

```
pwndbg> x/64gx 0x614e60
0x614e60:       0x0000000000000000      0x0000000000000021
0x614e70:       0x0000000000601d98      0x0000000000000000
0x614e80:       0x0000000000000000      0x0000000000000021
0x614e90:       0x0000000000601d78      0x0000000000000000
0x614ea0:       0x0000000000000000      0x0000000000000021
0x614eb0:       0x0000000000601d30      0x0000000000601d58
0x614ec0:       0x0000000000000000      0x000000000000f141
```

0x601d98æ˜¯white_giveç±»çš„è™šè¡¨

```
0x601d98 <vtable for white_give+16>:    0x0000000000400976      0x0000000000400982

0x400976 <white_give::gg1()>
0x400982 <white_give::gg2()>
```

0x601d78æ˜¯eggplantç±»çš„è™šè¡¨

```
0x601d78 <vtable for eggplant+16>:      0x000000000040098e      0x000000000040099a

0x40098e <eggplant::gg1()>
0x40098e <eggplant::gg1()>
```

0x601d30æ˜¯aubergineç±»çš„è™šè¡¨

```
0x601d30 <vtable for aubergine+16>:     0x0000000000400976      0x00000000004009a6
0x601d40 <vtable for aubergine+32>:     0x00000000004009de      0xfffffffffffffff8

0x400976 <white_give::gg1()>
0x4009a6 <aubergine::gg2()>
0x4009de <aubergine::gg4()>
```

0x601d58æ˜¯aubergineç±»çš„è™šè¡¨

```
0x601d58 <vtable for aubergine+56>:     0x000000000040098e      0x000000000040099a

0x40098e <eggplant::gg1()>
0x40099a <eggplant::gg3()>
```



#### åŠ«æŒè™šå‡½æ•°è¡¨

è™šè¡¨æŒ‡é’ˆå¯å†™ï¼Œå¯ä»¥åˆ©ç”¨uafã€å †æº¢å‡ºç­‰æ¼æ´æ”¹å†™è™šè¡¨æŒ‡é’ˆ

ä¾‹å¦‚åœ¨bsså†™å…¥shellcodeï¼Œåœ¨bss+len(shellcode)å†™å…¥bssçš„åœ°å€ï¼ŒæŠŠè™šè¡¨æŒ‡é’ˆæ”¹å†™ä¸ºbss+len(shellcode)

åœ¨è°ƒç”¨è™šå‡½æ•°æ—¶ï¼Œå°±ä¼šè·³è½¬åˆ°bssæ‰§è¡Œshellcode



### New & Delete

åœ¨C++ä¸­ç±»çš„å¯¹è±¡å»ºç«‹åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯é™æ€å»ºç«‹ï¼Œå¦‚A aï¼›å¦ä¸€ç§æ˜¯åŠ¨æ€å»ºç«‹A* p=new A()

é™æ€å»ºç«‹å¯¹è±¡ï¼Œç”±ç¼–è¯‘å™¨ä¸ºå¯¹è±¡åœ¨æ ˆä¸­åˆ†é…å†…å­˜ï¼Œé€šè¿‡ç›´æ¥ç§»åŠ¨æ ˆé¡¶æŒ‡é’ˆå¾—åˆ°é€‚å½“çš„ç©ºé—´ï¼Œç„¶åè°ƒç”¨æ„é€ å‡½æ•°åœ¨è¿™ç‰‡ç©ºé—´æ„é€ å¯¹è±¡

åŠ¨æ€å»ºç«‹å¯¹è±¡ï¼Œæ˜¯ä½¿ç”¨newè¿ç®—ç¬¦å°†å¯¹è±¡å»ºç«‹åœ¨å †ä¸­ï¼Œåœ¨æ ˆä¸­ä¿å­˜æŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆ

newå’Œdeleteçš„åº•å±‚æ˜¯mallocå’Œfree

* new

  1. operator new

     ä¸mallocç±»ä¼¼

     å¤±è´¥æ—¶è¿›å…¥exceptionè€Œmallocæ˜¯è¿”å›null

  2. constructor

* delete

  1. destructor

  2. operator delete

     ä¸freeç±»ä¼¼

| New            | Delete            |
| -------------- | ----------------- |
| new            | delete            |
| new[]          | delete[]          |
| operator new   | operator delete   |
| operator new[] | operator delete[] |
| malloc         | free              |

