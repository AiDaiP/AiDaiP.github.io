---
clayout: post
title:  "glibc2.29-off by one"
date:   2020-2-19
desc: ""
keywords: ""
categories: [Binary]
tags: [pwn]
icon: icon-html
---

#glibc2.29-off by one

## glibc2.29 unlink

```c
/* consolidate backward */
if (!prev_inuse(p)) {
  prevsize = prev_size (p);
  size += prevsize;
  p = chunk_at_offset(p, -((long) prevsize));
  if (__glibc_unlikely (chunksize(p) != prevsize))
    malloc_printerr ("corrupted size vs. prev_size while consolidating");
  unlink_chunk (av, p);
}
```
ç›¸æ¯”2.27ï¼Œæ–°å¢

```c
  if (__glibc_unlikely (chunksize(p) != prevsize))
    malloc_printerr ("corrupted size vs. prev_size while consolidating");
```

åœ¨2.27ä¸­ï¼Œoff by nullæœ‰ä¸€ç§overlappingæ–¹æ³•

1. malloc A B Cï¼ŒfreeAï¼ŒAè¿›unsorted bin
2. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by nullè¦†ç›–Cçš„prev_inuse
3. free Cï¼ŒAã€Bã€C unlink
4. mallocï¼ŒæŠŠAã€Bã€Cå–å›æ¥ï¼Œä¹‹å‰çš„Bå¹¶æ²¡æœ‰freeï¼Œå°±å¾—åˆ°äº†ä¸¤ä¸ªB

åœ¨ç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®Cçš„prev_sizeæ‰¾åˆ°Aï¼Œç„¶åç›´æ¥unlink

åœ¨2.29ä¸­ï¼Œæ–°å¢äº†å¯¹sizeçš„æ£€æŸ¥ï¼Œç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®Cçš„prev_sizeæ‰¾åˆ°Aï¼Œç„¶åæ£€æŸ¥Açš„sizeå’Œprev_sizeæ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰ç›´æ¥ggï¼Œå¦‚æœğŸ‘´æƒ³åƒ2.27ä¸€æ ·overlappingï¼ŒğŸ‘´è¿˜éœ€è¦å»ä¼ªé€ Açš„size

## è§£å†³æ–¹æ¡ˆ

### off by one

ä¼—æ‰€å‘¨çŸ¥off by oneæ¯”off by nullç™½ç»™ï¼Œå¦‚æœæ˜¯off by oneï¼ŒğŸ‘´å°±èƒ½åœ¨Aå‰é¢çš„chunkä¸­off by oneæ”¹Açš„size

1. malloc X A B Cï¼ŒfreeAï¼ŒAè¿›unsorted bin
2. åœ¨Xä¸­off by oneæ”¹Asize
3. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by oneæŠŠC prev_inuseæ”¹æˆ0
4. free Cï¼ŒAã€Bã€C unlink
5. mallocï¼ŒæŠŠAã€Bã€Cå–å›æ¥ï¼Œå¾—åˆ°ä¸¤ä¸ªB

### off by null

ä¼ªé€ ä¸€ä¸ªunsorted binï¼Œå†ä¼ªé€ prev_sizeï¼Œunlinkæ—¶æ ¹æ®prev_sizeæ‰¾åˆ°ä¼ªé€ çš„chunkï¼Œè¿‡check

ä¼ªé€ unsorted binæ—¶fdå’ŒbkæŒ‡å‘è‡ªå·±ï¼Œfd->bk = bk->fdï¼Œè¿™ç§æ–¹æ³•éœ€è¦å †åœ°å€ç™½ç»™

1. malloc A B C
2. åœ¨Aä¸­ä¼ªé€ fake chunkï¼Œsizeå’Œå°†è¦ä¼ªé€ çš„prev_sizeç›¸åŒï¼Œfdå’Œbkéƒ½æŒ‡å‘è‡ªå·±
3. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by oneæŠŠC prev_inuseæ”¹æˆ0
4. free Cï¼Œfake chunkã€Bã€C unlink
5. mallocï¼ŒæŠŠfake chunkã€Bã€C å–å›æ¥ï¼Œå¾—åˆ°ä¸¤ä¸ªB

#### 0CTF2019 Final babyheap2.29



