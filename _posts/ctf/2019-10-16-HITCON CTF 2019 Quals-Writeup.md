---
layout: post
title:  "HITCON CTF 2019 Quals-Writeup"
date:   2019-10-16
desc: ""
keywords: ""
categories: [Ctf]
tags: [CTF]
icon: icon-html
---

# HITCON CTF 2019 Quals-Writeup

## Lost Modulus Again

```python
from Crypto.Util.number import *


class Key:
    def __init__(self, bits):
        assert bits >= 512
        self.p = getPrime(bits)
        self.q = getPrime(bits)
        self.n = self.p * self.q
        self.e = 0x100007
        self.d = inverse(self.e, (self.p-1)*(self.q-1))
        self.dmp1 = self.d%(self.p-1)
        self.dmq1 = self.d%(self.q-1)
        self.iqmp = inverse(self.q, self.p)
        self.ipmq = inverse(self.p, self.q)

    def encrypt(self, data):
        num = bytes_to_long(data)
        result = pow(num, self.e, self.n)
        return long_to_bytes(result)

    def decrypt(self, data):
        num = bytes_to_long(data)
        v1 = pow(num, self.dmp1, self.p)
        v2 = pow(num, self.dmq1, self.q)
        result = (v2*self.p*self.ipmq+v1*self.q*self.iqmp) % self.n
        return long_to_bytes(result)

    def __str__(self):
        return "Key([e = {0}, n = {1}, x = {2}, y = {3}])".format(self.e, self.d, self.iqmp, self.ipmq)

def main():
    key = Key(1024)
    flag = open('flag').read()
    encrypt_flag = key.encrypt(flag)
    assert key.decrypt(encrypt_flag) == flag
    print key
    print encrypt_flag.encode('hex')


if __name__ == '__main__':
    main()

```

```
Key([e = 1048583, n = 20899585599499852848600179189763086698516108548228367107221738096450499101070075492197700491683249172909869748620431162381087017866603003080844372390109407618883775889949113518883655204495367156356586733638609604914325927159037673858380872827051492954190012228501796895529660404878822550757780926433386946425164501187561418082866346427628551763297010068329425460680225523270632454412376673863754258135691783420342075219153761633410012733450586771838248239221434791288928709490210661095249658730871114233033907339401132548352479119599592161475582267434069666373923164546185334225821332964035123667137917080001159691927, x = 22886390627173202444468626406642274959028635116543626995297684671305848436910064602418012808595951325519844918478912090039470530649857775854959462500919029371215000179065185673136642143061689849338228110909931445119687113803523924040922470616407096745128917352037282612768345609735657018628096338779732460743, y = 138356012157150927033117814862941924437637775040379746970778376921933744927520585574595823734209547857047013402623714044512594300691782086053475259157899010363944831564630625623351267412232071416191142966170634950729938561841853176635423819365023039470901382901261884795304947251115006930995163847675576699331])
32074de818f2feeb788e36d7d3ee09f0000381584a72b2fba0dcc9a2ebe5fd79cf2d6fd40c4dbfea27d3489704f2c1a30b17a783baa67229d02043c5bc9bdb995ae984d80a96bd79370ea2c356f39f85a12d16983598c1fb772f9183441fea5dfeb5b26455df75de18ce70a6a9e9dbc0a4ca434ba94cf4d1e5347395cf7aafa756c8a5bd6fd166bc30245a4bded28f5baac38d024042a166369f7515e8b0c479a1965b5988b350064648738f6585c0a0d1463bd536d11a105bb926b44236593b5c6c71ef5b132cd9c211e8ad9131aa53ffde88f5b0df18e7c45bcdb6244edcaa8d386196d25297c259fca3be37f0f2015f40cb5423a918c51383390dfd5a8703

```

已知e,d,inv(p,q),inv(q,p)

$pp'≡1mod(q)$

$qq'≡1mod(p)$

设

$p'p=1+kq$ ——(1)

$q'q=1+tp$ ——(2)

即

$(-k)q=1+ (-p')p$

$(-t)p=1+ (-q')q$

所以

$(-k)=inv(q,p)$

$(-t)=inv(p,q)$

即

$(-k)≡q'modp$

$(-t)≡p'modq$

设

$p'+t=iq$

$q'+k=jp$

代入(1)(2)

$in=1+kq+tp$

$jn=1+kq+tp$

所以$i=j$，设$i=j=x$

$p'+t=xq$ ——(4)

$q'+k=xp$ ——(5)

x很小，可以爆破

(1)两边同乘x

$p'xp=x+kxq$

(4)(5)代入

$p'(q'+k)=x+k(p'+t)$

展开

$p'q'-x=kt$——(6)

12222222

设

$ed=1+s(p-1)(q-1)$

 $\frac{(ed-1)}{s}=(p-1)(q-1)$

两边同乘$x^2$

$ \frac{x^2(ed-1)}{s}=(xp-x)(xq-x)$

(4)(5)代入

 $x^2\frac{(ed-1)}{s}=(q'+k-x)(p'+t-x)$

右侧展开

 $x^2[\frac{(ed-1)}{s}-1]-p'q'+x(p'+q')-kt=(q'-x)t+(p'-x)k$ ——(7)

(6)(7)解方程，e,d,p',q'已知，爆破x,s

```python
from sympy import *

e = 1048583
d = 20899585599499852848600179189763086698516108548228367107221738096450499101070075492197700491683249172909869748620431162381087017866603003080844372390109407618883775889949113518883655204495367156356586733638609604914325927159037673858380872827051492954190012228501796895529660404878822550757780926433386946425164501187561418082866346427628551763297010068329425460680225523270632454412376673863754258135691783420342075219153761633410012733450586771838248239221434791288928709490210661095249658730871114233033907339401132548352479119599592161475582267434069666373923164546185334225821332964035123667137917080001159691927
pp = 138356012157150927033117814862941924437637775040379746970778376921933744927520585574595823734209547857047013402623714044512594300691782086053475259157899010363944831564630625623351267412232071416191142966170634950729938561841853176635423819365023039470901382901261884795304947251115006930995163847675576699331
qq = 22886390627173202444468626406642274959028635116543626995297684671305848436910064602418012808595951325519844918478912090039470530649857775854959462500919029371215000179065185673136642143061689849338228110909931445119687113803523924040922470616407096745128917352037282612768345609735657018628096338779732460743
c = 0x32074de818f2feeb788e36d7d3ee09f0000381584a72b2fba0dcc9a2ebe5fd79cf2d6fd40c4dbfea27d3489704f2c1a30b17a783baa67229d02043c5bc9bdb995ae984d80a96bd79370ea2c356f39f85a12d16983598c1fb772f9183441fea5dfeb5b26455df75de18ce70a6a9e9dbc0a4ca434ba94cf4d1e5347395cf7aafa756c8a5bd6fd166bc30245a4bded28f5baac38d024042a166369f7515e8b0c479a1965b5988b350064648738f6585c0a0d1463bd536d11a105bb926b44236593b5c6c71ef5b132cd9c211e8ad9131aa53ffde88f5b0df18e7c45bcdb6244edcaa8d386196d25297c259fca3be37f0f2015f40cb5423a918c51383390dfd5a8703

t = Symbol('t')
k = Symbol('k')

for x in range(1,100):
	for s in range(1,100000):
		t = Symbol('t')
		k = Symbol('k')

		x=1
		s=973605
		val2 = qq-x
		val3 = pp-x
		val4 = pp*qq-x
		val1 = x*x*((e*d - 1)//s-1)+x*(pp+qq)-pp*qq-val4
		res = solve([val1-val2*t-val3*k,val4-k*t],[k,t])
		print(res)
		k = int(res[1][0])
		t = int(res[1][1])

		xp, xq = qq + k, pp + t
		p, q = xp // x, xq // x
		n = p*q
		m = hex(pow(c,d,n))[2:].strip('L')
		if len(m)%2==1:
			m = '0' + m
		if 'hitcon' in m.decode('hex'):
			print(m.decode('hex'))
			exit()
```



