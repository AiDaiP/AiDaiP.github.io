---
layout: post
title:  "Fastbin Attack"
date:   2019-7-15
desc: ""
keywords: ""
categories: [Binary]
tags: [pwn]
icon: icon-html
---

# Fastbin Attack

![11](https://raw.githubusercontent.com/AiDaiP/images/master/pwn/11.png)

#### Fastbin Attack

- ##### 条件

  1. 存在堆溢出、use-after-free 等能控制 chunk 内容的漏洞
  2. 漏洞发生于 fastbin 类型的 chunk 中

- ##### 原理

  ```c
  int main(void)
  {
      void *chunk1,*chunk2,*chunk3;
      chunk1=malloc(0x30);
      chunk2=malloc(0x30);
      chunk3=malloc(0x30);
      free(chunk1);
      free(chunk2);
      free(chunk3);
      printf("gg");
      return 0;
  }
  ```

  free前

  ```c
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000041 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000000
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000000041 <=== chunk2
  0x84022a0:      0x0000000000000000      0x0000000000000000
  0x84022b0:      0x0000000000000000      0x0000000000000000
  0x84022c0:      0x0000000000000000      0x0000000000000000
  0x84022d0:      0x0000000000000000      0x0000000000000041 <=== chunk3
  0x84022e0:      0x0000000000000000      0x0000000000000000
  0x84022f0:      0x0000000000000000      0x0000000000000000
  0x8402300:      0x0000000000000000      0x0000000000000000
  0x8402310:      0x0000000000000000      0x0000000000020cf1 <=== top chunk
  ```

  free后

  ```c
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000041 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000000
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000000041 <=== chunk2
  0x84022a0:      0x0000000008402260      0x0000000000000000
  0x84022b0:      0x0000000000000000      0x0000000000000000
  0x84022c0:      0x0000000000000000      0x0000000000000000
  0x84022d0:      0x0000000000000000      0x0000000000000041 <=== chunk3
  0x84022e0:      0x00000000084022a0      0x0000000000000000
  0x84022f0:      0x0000000000000000      0x0000000000000000
  0x8402300:      0x0000000000000000      0x0000000000000000
  0x8402310:      0x0000000000000000      0x0000000000020cf1 <=== top chunk
  
  chunk3 ==> chunk2 ==> chunk1
  ```

  

- ##### Fastbin Double Free

  ```c
  int main(void)
  {
      void *chunk1,*chunk2;
      chunk1=malloc(0x10);
      chunk2=malloc(0x10);
      free(chunk1);
      free(chunk1);
      printf("gg");
      return 0;
  }
  ```

  free前

  ```c
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  ```

  free后

  ```c
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000008402260      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  
  chunk1 —▸ chunk1
  ```

  

  ```c
  int main(void)
  {
      void *chunk1,*chunk2;
      chunk1=malloc(0x10);
      chunk2=malloc(0x10);
      free(chunk1);
      free(chunk2);
      free(chunk1);
      printf("gg");
      return 0;
  }
  ```

  free前

  ```c
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  ```

  free

  ```c
  第一次free
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000000000000      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  
  第二次free
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000000000000      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000008402260      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  
  第三次free
  pwndbg> x/64gx 0x8402250
  0x8402250:      0x0000000000000000      0x0000000000000021 <=== chunk1
  0x8402260:      0x0000000008402280      0x0000000000000000
  0x8402270:      0x0000000000000000      0x0000000000000021 <=== chunk2
  0x8402280:      0x0000000008402260      0x0000000000000000
  0x8402290:      0x0000000000000000      0x0000000000020d71 <=== top chunk
  
  chunk1 ==> chunk2 ==> chunk1
  ```

  

