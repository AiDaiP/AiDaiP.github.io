---
layout: post
title:  "Unlink"
date:   2019-7-16
desc: ""
keywords: ""
categories: [Binary]
tags: [pwn,heap]
icon: icon-html
---

# Unlink

* #### Unlink源码

  ```c
  #define unlink(AV, P, BK, FD)                                                  
      {                                                                          
          FD = P->fd;                                                            
          BK = P->bk;                                                            
          if (__builtin_expect(FD->bk != P || BK->fd != P, 0))                   
              malloc_printerr(check_action, "corrupted double-linked list", P,   
                              AV);                                               
          else {                                                                 
              FD->bk = BK;                                                       
              BK->fd = FD;                                                       
              if (!in_smallbin_range(chunksize_nomask(P)) &&                     
                  __builtin_expect(P->fd_nextsize != NULL, 0)) {                 
                  if (__builtin_expect(P->fd_nextsize->bk_nextsize != P, 0) ||   
                      __builtin_expect(P->bk_nextsize->fd_nextsize != P, 0))     
                      malloc_printerr(                                           
                          check_action,                                          
                          "corrupted double-linked list (not small)", P, AV);    
                  if (FD->fd_nextsize == NULL) {                                 
                      if (P->fd_nextsize == P)                                   
                          FD->fd_nextsize = FD->bk_nextsize = FD;                
                      else {                                                     
                          FD->fd_nextsize             = P->fd_nextsize;          
                          FD->bk_nextsize             = P->bk_nextsize;          
                          P->fd_nextsize->bk_nextsize = FD;                      
                          P->bk_nextsize->fd_nextsize = FD;                      
                      }                                                          
                  } else {                                                       
                      P->fd_nextsize->bk_nextsize = P->bk_nextsize;              
                      P->bk_nextsize->fd_nextsize = P->fd_nextsize;              
                  }                                                              
              }                                                                  
          }                                                                      
      }
  ```

  把一个双向链表中的空闲块拿出来

  例：free 时和目前物理相邻的 free chunk 进行合并 

  ![2](https://raw.githubusercontent.com/AiDaiP/images/master/堆/2.png)

  

* #### 绕过检查

  unlink时检查FD->bk 和 BK->fd 指向将要free的块

  构造chunk可以绕过检查，如fd = chunk0 - 0x18; bk = chunk0 - 0x10

* #### 利用思路

  * 条件

    1. UAF ，可修改 free 状态下 smallbin 或是 unsorted bin 的 fd 和 bk 指针
    2. 已知位置存在一个指针指向可进行 UAF 的 chunk

  * 过程

    1. 修改 fd 为 ptr - 0x18
    2. 修改 bk 为 ptr - 0x10
    3. 触发 unlink

    ptr 处的指针会变为 ptr - 0x18。 